*边学边翻译，督促自己不能落下，同时也留点记忆*

# <center>**第十三章 采样**</center> 

***
&nbsp;&nbsp;&nbsp;&nbsp;图形中的许多应用程序需要对不寻常的空间进行“合理的”采样，例如所有可能的线的空间。例如，我们可能需要生成像素内的随机边，或者像素上的随机采样点，这些点的密度根据某种密度函数变化。本章提供了这种概率运算的原理。这些技术也将被证明是有用的数值计算复杂的积分使用蒙特卡洛积分，也包括在本章。
***
### 13.1 积分
&nbsp;&nbsp;&nbsp;&nbsp;虽然“积分”和“测量”这两个词看起来很吓人，但它们与数学中一些最直观的概念有关，所以不应该害怕。对于我们非常不严谨的目的，度量只是一个函数，它将子集映射到R+，以一种与我们对长度、面积和体积的直观概念一致的方式。例如，在二维实平面R2上，我们有面积测量为平面上的一组点赋值。注意，A只是一个取平面的部分并返回面积的函数。这意味着定义域A是所有可能的子集：
$$
A:\Rho (\mathbb{R}^2)\to \mathbb{R}^+
$$
&nbsp;&nbsp;&nbsp;&nbsp;一个应用面积测度的例子表明，边长为1的正方形的面积为1:
$$
A([a, a + 1] × [b, b + 1]) = 1
$$
&nbsp;&nbsp;&nbsp;&nbsp;其中(a, b)是正方形的左下角。注意，诸如(3,7)这样的单点是R2的有效子集，其面积为零:a((3,7)) = 0。x轴上的点集合S也是如此，S = (x, y)使(x, y)∈R2且y =0，即A(S)=0。这样的集合称为零度量集
&nbsp;&nbsp;&nbsp;&nbsp;要被认为是度量，函数必须服从某些类似于面积的性质。例如，有一个函数μ: P(S)→R+。对于μ作为度量，必须满足以下条件:
1. 空集的测度为0:μ(∅)=0
2. 两个不同集合的尺度是它们单独尺度的和。这个有交集的规则是
    μ(A ∪ B) = μ(A) + μ(B) − μ(A ∩ B)
&nbsp;&nbsp;&nbsp;&nbsp;其中∪是集并算子，∩是集交集算子
&nbsp;&nbsp;&nbsp;&nbsp;当我们实际计算度量时，我们通常使用积分。我们可以把积分看成符号:
$$
A(S) = \int_{x\in S}dA(x)
$$
&nbsp;&nbsp;&nbsp;&nbsp;你可以把右边非正式地理解为“取区域S中的所有点x，并把它们相关的微分面积相加。”积分通常有其他的写法，包括:
$$
\int_{S}dA ,~~~\int_{X\in S}dx,~~~\int_{X\in S}dAx,~~~\int_Xdx,
$$
&nbsp;&nbsp;&nbsp;&nbsp;上面所有的公式都表示“区域s的面积”，我们将坚持使用我们使用的第一个公式，因为它是如此冗长，它避免了歧义。为了解析地计算这样的积分，我们通常需要建立一个坐标系，并使用微积分的技巧来求解这些方程。但如果这些技巧已经消失了，也不用担心，因为我们通常需要对积分进行数值近似，而这只需要13.3节中描述的简单技巧。
&nbsp;&nbsp;&nbsp;&nbsp;给定集合S上的一个测度，我们总是可以通过对非负函数w: S→R+进行加权来创建一个新的测度。最好的表达方式是符号。例如，我们可以从$[0,1]^2$上的简单面积测量开始
$$
\int_{X\in[0,1]^2}dA(x),
$$
&nbsp;&nbsp;&nbsp;&nbsp;我们可以通过插入半径平方的权重函数来使用“径向加权”度量:
$$
\int_{X\in[0,1]^2}||A||^2dA(x),
$$
&nbsp;&nbsp;&nbsp;&nbsp;为了解析地计算它，我们可以用一个笛卡尔坐标系展开dA≡dx dy:
$$
\int_{X\in[0,1]^2}||A||^2dA(x)= \int_{x=0}^1 \int_{y=0}^1(x^2+y^2)dxdy
$$
&nbsp;&nbsp;&nbsp;&nbsp;这里的关键是，如果你把x2期和dA期结合起来，这些一起形成了一个新的测量值，我们称之为ν。这就可以写成ν(S)而不是整个积分。如果你有这种感觉仅仅是一堆符号和记账，你是对的。但它确实允许我们写出要么紧化要么展开的方程取决于我们的偏好。
#### 13.1.1 措施和平均
&nbsp;&nbsp;&nbsp;&nbsp;当取一个函数的平均值时，测量才真正开始奏效。您只能对特定的度量取一个平均值，并且您希望为应用程序或域选择一个“自然的”度量。一旦选择了度量，函数f在区域S上关于度量μ的平均值为
$$
average(f) \equiv \frac{\int_{x\in S}f(x)du(x)}{\int_{x\in S}du(x)}
$$
&nbsp;&nbsp;&nbsp;&nbsp;例如，函数f(x, y) = x2 /[0,2]2关于面积测度的平均值是
$$
average(f) \equiv \frac{\int_{x=0}^2\int_{y=0}^2x^2dxdy}{\int_{x=0}^2\int_{y=0}^2dxdy} =\frac{4}{3}
$$
&nbsp;&nbsp;&nbsp;&nbsp;这种机制有助于解决看似困难的问题，在这些问题中，选择测量方法是棘手的部分。这样的问题经常出现在积分几何中，这是一个研究几何实体上的度量的领域，如线和平面。例如：计算一条线在$[0,1]^2$区间的长度。定义如下：
$$
Average(length)=\frac{\int_{lines~L~through[0,1]^2}length(L)du(L)}{\int_{lines~L~through[0,1]^2}u(L)}
$$
&nbsp;&nbsp;&nbsp;&nbsp;剩下的，一旦我们知道了，就是为应用选择合适的p。这将在下一节中处理
#### 13.1.2举例:二维平面直线上的测量
&nbsp;&nbsp;&nbsp;&nbsp;什么度量p是“自然的”?
&nbsp;&nbsp;&nbsp;&nbsp;如果将直线参数化为y = mr + b，则可以将给定的直线看作“斜率-截距”空间中的点(m, b)。一个容易使用的度量是dm db，但这不是一个“好的”度量，因为不是所有大小相同的行“束”都有相同的度量。更准确地说，这个度量对于坐标系的变化不是不变的。例如，如果让所有的线穿过正方形[0,1]2，那么穿过它的线的长度就不等于穿过旋转45°的单位正方形的长度。我们真正想要的是一个“公平的”度量，它不随一组直线的旋转或平移而改变。这个想法在图13.1和13.2中得到了说明。
&nbsp;&nbsp;&nbsp;&nbsp;要在直线上建立一个自然的度量，我们首先应该把它们看作对偶空间中的点。这是一个简单的概念:直线y = mr + b可以指定为斜率-截距空间中的点(m, b)。这个概念如图13.3所示。在(φ， b)空间中建立测度更为直接。在该空间中，b为y轴截距，φ为直线与r轴的夹角，如图13.4所示。在这里，差分度量dodb几乎可以工作，但由于图13.1所示的效果，它将不公平。为了解释恒定宽度的线束所形成的更大的跨度b，我们必须加上一个余弦因子:
$$
du = \cos \phi d\phi db.
$$
du= cos φ dφ db.
&nbsp;&nbsp;&nbsp;&nbsp;可以证明，在一个常数范围内，这个度量是唯一对旋转和平移不变的度量。
&nbsp;&nbsp;&nbsp;&nbsp;此度量可以转换为用于直线的其他参数化的适当度量。例如，(m, b)空间的适当度量
$$
du = \frac{dm db}{(1+m^2)^{\frac{3}{3}}}
$$
对于以(a, b)为参数的直线，r截距和y截距为方法为
$$
du =\frac{ab~da~db}{(u^2+v^2)^{\frac{3}{2}}}
$$
&nbsp;&nbsp;&nbsp;&nbsp;请注意，这些空格都是指定行的相同有效方法，哪种方法最好取决于具体情况。然而，有人可能想知道是否存在这样一个坐标系，其中一组直线的度量只是对偶空间中的一个区域。事实上，确实有这样一个坐标系，而且简单得令人愉快;
它是法线坐标，根据从原点到直线的法线距离和直线的法线相对于r轴的角度来指定一条直线(图13.5)。这类直线的隐式方程是
$$
x\cos\theta +y\sin\theta -p = 0
$$
&nbsp;&nbsp;&nbsp;&nbsp; 事实上，这个空间的度量是
$$
du = dp~d\theta
$$
&nbsp;&nbsp;&nbsp;&nbsp;我们将在后面的部分中使用这些方法来选择均匀的随机线。
#### 13.1.3示例:三维直线测量
&nbsp;&nbsp;&nbsp;&nbsp;在3D中，有许多方法来参数化直线。也许，最简单的方法是使用它们与特定平面的交点，以及它们的方向。例如，我们可以画出与ry平面的交点及其方向的球坐标。因此，每一行将被指定为(r, y, 9，)四组。这表明3D中的线是4D实体;例如，它们可以描述为4D空间中的点。
&nbsp;&nbsp;&nbsp;&nbsp;一条直线的微分测度不应随(r, y)而变化，但具有相等截面的直线束应具有相等的测度。因此，一个公平的微分测量是
$$
du=dx~dy\sin\theta d\theta d \phi
$$
&nbsp;&nbsp;&nbsp;&nbsp;另一种参数化直线的方法是画出与两个平行平面的交点。例如，如果这条直线在(z = u, y = u)处与平面z = 0相交，在(x = s, y = t)处与平面z = 1相交，那么这条直线可以用四重(u, u, s,t)来描述。请注意，与前面的参数化一样，这个参数化对于平行于zy平面的线是简并的。对于这种参数化，微分测量更为复杂，尽管它可以近似为
$$
du \approx du~dv~a~ds~dt
$$
对于几乎平行于z轴的线束。这是在基于图像的渲染中经常隐式使用的度量。
&nbsp;&nbsp;&nbsp;&nbsp;对于与球面相交的直线集，我们可以使用直线与球面相交的两点的参数化。如果这些在球坐标中，那么这个点可以用四重(01,1,92,2)来描述，度量就是与每个点相关的微分面积:
$$
d\mu = \sin\theta _1 d\theta _1 \sin\theta _2 d\theta _2 d \phi _2
$$
&nbsp;&nbsp;&nbsp;&nbsp;这意味着在球上选择两个均匀随机端点会得到一条具有均匀密度的线。Mateu Sbert在他的论文(Sbert, 1997)中使用了这一观察结果来计算形状因子。
&nbsp;&nbsp;&nbsp;&nbsp;注意，有时我们希望参数化直线，有时我们希望端点的顺序不重要。这是一个记录细节，对于沿着一条直线的光量沿直线的两个方向不同的渲染应用程序尤其重要。
***
### 13.2连续概率
&nbsp;&nbsp;&nbsp;&nbsp;注许多图形算法利用概率构造随机样本来解决积分和平均问题。这是应用连续概率的领域，与测度理论有基本联系。
#### 13.2.1一维连续概率密度函数
&nbsp;&nbsp;&nbsp;&nbsp;松散地说，一个连续的随机变量r是一个标量或矢量，它“随机”地从实线r = (-00， |o)取某个值。r的行为完全由它所取值的分布来描述。这种值的分布可以用
与r相关的概率密度函数(pdf)， p(关系记为r ~ p)。r在某区间[a, b]中假设某一特定值的概率由以下积分给出:
$$
Probability(x\in[a,b]) = \int_a^bp(x)dx 
$$
&nbsp;&nbsp;&nbsp;&nbsp;粗略地说，概率密度函数p表示取某一值的随机变量的相对可能性;如果p(z1) = 6.0和p(T2) = 3.0，那么密度为p的随机变量在“靠近”处有值的可能性是在rz附近有值的两倍。密度p有两个特征:
$$
p(x)\geq 0 (probability is noegative),\\
\int_{-\infty}^{+\infty}p(x)dx = 1 (Probability(x\in\mathbb R)=1)
$$
&nbsp;&nbsp;&nbsp;&nbsp;作为一个例子，标准随机变量f的值在0(包含)和1(不包含)之间具有均匀概率(这里简单地说是均匀的)。意味着f的每个值都是等可能的)。这意味着ξ值的概率密度函数q为
$$
q(\varepsilon) = \begin{cases}
1 &if 0\leq\varepsilon<1, \\
0 &otherwise
\end{cases}
$$
&nbsp;&nbsp;&nbsp;&nbsp;定义f的空间就是区间[0,1)。ξ值在一定区间[a,b] E[0,1)内的概率为
$$
Probability(a\leq\varepsilon\leq b) = \int_a^b1dx=b-a
$$

#### 13.2.2一维期望值
&nbsp;&nbsp;&nbsp;&nbsp;下面是pdp的一维随机变量的实函数f的平均值称为它的期望值E(f(r))(有时写为Ef(x)):
E(f(z)) = | f(z)p(z)dz。
&nbsp;&nbsp;&nbsp;&nbsp;一维随机变量的期望值可以通过设f(x) = r来计算。期望值有一个令人惊讶而有用的性质:两个随机变量之和的期望值为两个随机变量的期望值之和:
E（z + y） = E（z） + E（y），
&nbsp;&nbsp;&nbsp;&nbsp;因为随机变量的函数本身就是随机变量，所以期望的线性也适用于它们:
E(x) + g(y) = E(f) (z) + E(g)
&nbsp;&nbsp;&nbsp;&nbsp;一个显而易见的问题是，如果被求和的随机变量是相关的(不相关的变量称为独立的)，那么这个性质是否成立。这种线性性质实际上是成立的，无论变量是否独立!这个求和性质对于大多数蒙特卡洛应用是至关重要的。
#### 13.2.3多维随机变量
&nbsp;&nbsp;&nbsp;&nbsp;对随机变量及其期望值的讨论很自然地延伸到多维空间。大多数图形问题都是在这样的高维空间中。例如，许多照明问题是在半球的表面上表述的。幸运的是，如果我们在随机变量所占空间上定义一个度量p，一切都与一维情况非常相似。假设空间S有相关的度量p;例如，S是球面，p是面积。我们可以定义一个pdf p: S + R，如果R是一个R ~ p的随机变量，那么R在某个区域S取某个值的概率;cs由积分给出
$$
Probability(x\in S_i)=\int_{s_i}p(x)du
$$
&nbsp;&nbsp;&nbsp;&nbsp;这里，概率(事件)是事件为真的概率，所以积分是r在区域S中取某值的概率。
&nbsp;&nbsp;&nbsp;&nbsp;在图形学中，S通常是一个面积(du = dA = dzdy)或一组方向(单位球上的点:du = dA = sin 9 de do)。例如，二维随机变量a是半径为的圆盘上的均匀分布随机变量
R.在这里，uniform指的是相对于区域来说是一致的，例如，一个糟糕的飞镖手的命中会分布在飞镖板上。因为它是均匀的，我们知道p(a)是一个常数。从圆盘的面积为nr?总概率是1，我们可以推导出来
$$
p(a)=\frac{1}{\pi R^2}
$$
&nbsp;&nbsp;&nbsp;&nbsp;这意味着a在磁盘的某个子集Si中的概率是
$$
Probability(a\in S_1)=\int_{S_1}\frac{1}{\pi R^2}dA 
$$
&nbsp;&nbsp;&nbsp;&nbsp;这些都非常抽象。要真正使用这个信息，我们需要积分的形式可以求值。假设S，是圆盘上比周长更靠近中心的部分。如果转换到极坐标，则a表示为(r, o)对，Si是r < r /2的区域。请注意，仅仅因为a是一致的，并不意味着o或r一定是一致的(事实上，o是一致的，而r不是一致的)。微分面积dA就是rdr。因此,
$$
Probability(r<\frac{R}{2})=\int_0^{2\pi} \int_0^{\frac{\pi}{2}}frac{1}{\pi R^2}rdrd\phi = 0.25
$$
&nbsp;&nbsp;&nbsp;&nbsp;实函数的期望值公式也适用于多维情况:
$$
E(f(x)) = \int_sf(x)p(x)d\mu,
$$
其中r E S和f: S+ r，和p: S+ r。例如，在单位平方S= [0,1] x[0,1]和p(z, y) = 4ry上，(r, y) ~ p的r坐标的期望值为
$$
\begin{aligned}
E(x) &=\int_Sf(x,y)p(x,y)dA\\
&= \int_0^1\int_0^24x^2ydxdy\\
&= \frac{2}{3}
\end{aligned}
$$
&nbsp;&nbsp;&nbsp;&nbsp;注意这里f(x, y) = r。
#### 13.2.4方差
&nbsp;&nbsp;&nbsp;&nbsp;一维随机变量的方差V(r)，根据定义，是r与E(z)之差的平方的期望值:
$$
V(x) = E([x - E(x)]^2)。
$$
&nbsp;&nbsp;&nbsp;&nbsp;一些代数运算给出了不明显的表达式:
$$
V(x) = E(x^2) - [E(x)]^2。
$$
&nbsp;&nbsp;&nbsp;&nbsp;表达式E([x - E(r)]2)对于直观地考虑方差更有用，而代数等价表达式E(r2) - [E(x)]2通常更便于计算。随机变量的和的方差等于变量独立时方差的和。方差的这种求和性质是它经常用于概率模型分析的原因之一。方差的平方根称为标准偏差o，它给出了与期望值的期望绝对偏差的某种指示。
#### 13.2.5估计方法
&nbsp;&nbsp;&nbsp;&nbsp;许多问题涉及到独立随机变量zi的和，其中变量共享一个共同的密度p。这样的变量被称为独立同分布(iid)随机变量。当这个和除以变量的数量时，我们得到E(x)的估计值:
$$
E (x) \approx\frac{1}{N}\sum_{i=1}^Nx_i
$$
&nbsp;&nbsp;&nbsp;&nbsp;随着N的增加，这个估计的方差减小。我们希望N足够大，以便我们有信心估计是“足够接近”的。然而，在蒙特卡洛没有确定的事情;我们只是获得了统计上的信心，我们的估计是正确的。当然，我们必须有N = oo。这种信心可以用大数定律来表达:
$$
Probability\left[E(x)=\lim_{N\to\in4}\frac{1}{N}\sum_{i=1}^Nx_i\right]=1
$$

***
### 13.3蒙特卡洛积分
&nbsp;&nbsp;&nbsp;&nbsp;本文概述了定积分的基本蒙特卡罗解法。这些技术可以直接应用于某些积分问题。本节的所有基本材料也包括在几个经典的蒙特卡洛文本。(参见本章末尾的“注释”部分。)如前所述，给定函数f: Sr> R和随机变量a ~ p，我们可以通过和近似f(x)的期望值:
$$
E(f(x)) = \int_{x\in S}f(x)p(x)d\mu \approx\frac{1}{N}\sum_{i=1}d(x_i)   \tag{13.4}
$$
&nbsp;&nbsp;&nbsp;&nbsp;因为期望值可以用积分表示，所以积分也可以用和近似表示。式(13.4)的形式有点尴尬;我们通常喜欢近似一个函数g的积分，而不是一个乘积fp。我们可以通过将g = fp替换为被积函数来实现:
$$
\int_{x\in S}g(x)d\mu \approx \frac{1}{N}\sum_{i=1}^{N}\frac{g(x_i)}{p(x_i)}
$$
&nbsp;&nbsp;&nbsp;&nbsp;为了使这个公式成立，当g非零时p必须为正。
&nbsp;&nbsp;&nbsp;&nbsp;因此，为了得到一个好的估计，我们需要尽可能多的样本，并且我们希望g/p具有较低的方差(g和p应该具有相似的形状)。聪明地选择p叫做重要抽样，因为如果p大而g大，那么重要区域的样本就会更多。式(13.4)也显示了蒙特卡洛积分的基本问题:收益递减。因为估计的方差与1/N成正比，所以标准差与1/VN成正比。由于估计中的误差表现得与标准偏差相似，我们需要将N增加四倍以使误差减半。
&nbsp;&nbsp;&nbsp;&nbsp;另一种减少方差的方法是将积分域S划分为几个较小的域Si，并将积分计算为对S的积分和。这被称为层馈采样，抖动在像素采样中使用的技术(第4章)。通常，每个Sa只取一个样本(密度p;)，在这种情况下，估计的方差为
$$
var \left( \sum_{i=1}^{N}\frac{g(x_i)}{p(x_i)} \right)=\sum_{i=1}^N var
\left(\frac{g(x_i)}{p_i(x_i)}\right)
$$
&nbsp;&nbsp;&nbsp;&nbsp;可以看出，如果所有地层的度量相等，分层抽样的方差永远不会比未分层抽样的方差大:
$$
\int_{S_i}p(x)d\mu = \frac{1}{N}\int_Sp(x)d\mu
$$
图形中分层采样最常见的例子是像素采样的抖动。
&nbsp;&nbsp;&nbsp;&nbsp;作为积分I的蒙特卡罗解的一个例子，设g(z)等于r在区间(0,4)
$$
I = \int_0^4xdx = 8 \tag{13.7}
$$
&nbsp;&nbsp;&nbsp;&nbsp;函数p的形状对N个样本估计方差的影响如表13.1所示。注意，当p的形状与g的形状相似时，方差减小。如果p = g/1，方差降为零，但是我通常是不知道的，否则我们不会求助于蒙特卡洛。表13.1中阐明的一个重要原则是，分层抽样往往远远优于重要性抽样(Mitchell, 1996)。尽管在I上这种分层的方差与样本数量的立方成反比，但对于分层下的方差行为没有一般的结果。有一些功能，分层是没有好处的。一个例子是白噪声函数，它的方差对所有区域都是恒定的。另一方面，大多数函数将受益于分层抽样，因为每个子单元的方差通常小于整个定域的方差。
#### 13.3.1拟蒙特卡罗积分
&nbsp;&nbsp;&nbsp;&nbsp;常用的求积分方法是用准随机点代替蒙特卡罗积分中的随机点。这些点是确定的，但在某种意义上是一致的。例如，在单位正方形[0,1]2上，一组N个准随机点在正方形内面积a的区域上应具有以下性质:
$$
Number~~of~points ~in ~the ~region \approx AN.
$$
&nbsp;&nbsp;&nbsp;&nbsp;例如，格子中的一组规则样本就具有这个性质。
&nbsp;&nbsp;&nbsp;&nbsp;准随机点可以在许多集成应用中提高性能。有时，必须小心确保它们不会引入混叠。特别好的是，在调用[0,1]中的随机或分层点的任何应用程序中，可以不做其他更改替换d维准随机点。
&nbsp;&nbsp;&nbsp;&nbsp;激发准蒙特卡洛积分的关键直觉是，在估计被积函数的平均值时，任何样本点集合都可以，只要它们是“公平的”。
***
### 13.4选择随机点
&nbsp;&nbsp;&nbsp;&nbsp;我们通常希望在单位方格上生成随机或伪随机点集，用于分布射线跟踪等应用。有几种方法可以做到这一点，例如抖动。这些方法给我们一组在单位正方形[0,1]2:(u1,01)到(ux, UN)上合理均匀分布的N个点。
&nbsp;&nbsp;&nbsp;&nbsp;有时，我们的采样空间可能不是方形的(如圆形透镜)或可能不是均匀的(如以像素为中心的波函数)。如果我们能写一个数学变换将等分布点(ui, u;)作为输入和输出在我们期望的采样空间中具有期望密度的一组点，那就太好了。例如，要对一个相机镜头采样，变换需要(u，)和输出(r，，o，)，这样新的点就近似地均匀分布在镜头的圆盘上。虽然我们可能会想用变换:
$$
\phi_i = 2\pi u_i,\\
r_i=v_iR
$$
&nbsp;&nbsp;&nbsp;&nbsp;它有一个严重的问题。虽然这些点确实覆盖了透镜，但它们是不均匀的(图13.6)。在这种情况下我们需要的是一个变换将等面积的区域变成等面积的区域一个将正方形上的均匀抽样分布变成新定义域上的均匀抽样分布。
&nbsp;&nbsp;&nbsp;&nbsp;有几种方法可以在非矩形域上生成这种非均匀点或均匀点，下面几节将介绍最常用的三种方法:函数反转、拒绝和Metropolis。
#### 13.4.1函数反演
&nbsp;&nbsp;&nbsp;&nbsp;如果密度f(r)是一维的，并且定义在区间TEmin, Imax]上，那么我们可以生成随机数a，其密度f来自一组均匀随机数fi，其中fi E[0,1]。为此，我们需要累积概率分布函数P(r):
$$
Probability(α<x) = P(x) = \int_{x_{min}}^xf(x')d\mu
$$
&nbsp;&nbsp;&nbsp;&nbsp;为了得到a，，我们只需对ξ进行变换:
$$
a_i = P^-1(\varepsilon_i)
$$
&nbsp;&nbsp;&nbsp;&nbsp;如果P不是解析可逆的，那么数值方法就足够了，因为所有有效的概率分布函数都存在一个逆函数。
&nbsp;&nbsp;&nbsp;&nbsp;注意，由于符号的关系，解析反求一个函数比它应该的更令人困惑。例如，如果我们有一个函数 对于r > O，则反函数用y表示为z的函数:
$$
y =x^2
$$
&nbsp;&nbsp;&nbsp;&nbsp;当函数是解析可逆时，它几乎总是那么简单。然而，使用标准表示法，事情就不那么透明了:
$$
f(x) = x^2,\\
f^-1(x) =\sqrt{x} 
$$
&nbsp;&nbsp;&nbsp;&nbsp;这里，x只是一个哑变量。你可能会发现使用不那么标准的符号更容易:
$$
y=x^2,\\
x=\sqrt{y},
$$
&nbsp;&nbsp;&nbsp;&nbsp;但要记住，它们是互为反函数的。
&nbsp;&nbsp;&nbsp;&nbsp;例如，随机选择有密度的点r
$$
p(x)=\frac{3x^2}{2}
$$
&nbsp;&nbsp;&nbsp;&nbsp;在[-1,1]上，我们看到了
$$
P(x) = \frac{x^3+1}{2}
$$
&nbsp;&nbsp;&nbsp;&nbsp;而且
$$
P^-1(x)=\sqrt[3]{2x-1}
$$
&nbsp;&nbsp;&nbsp;&nbsp;因此我们可以将一组规范随机数(......N)“扭曲”为适当分布的数
$$
(x_1,\cdots,x_N) = (\sqrt[3]{2\varepsilon_{1}-1},\cdots,\sqrt[3]{2\varepsilon_{N}-1})
$$
&nbsp;&nbsp;&nbsp;&nbsp;当然，同样的翘曲函数也可以用来将“均匀的”抖动样本转化为具有所需密度的分布良好的样本。
&nbsp;&nbsp;&nbsp;&nbsp;如果我们有一个随机变量a = (ar, ay)，二维密度(r, y)定义在[Tmin, Imax] X [min, Ymax]上，那么我们需要二维分布函数:
$$
Probability(α_x < x ~and~ α_y < y) = F(x, y) =\int_{y_min}^y\int_{x_min}^xf(x',y')d\mu(x',y')
$$
&nbsp;&nbsp;&nbsp;&nbsp;我们首先选择r，利用边际分布F(r, ymax)，然后根据F(Tiy)/F(Ti9max)选择9i。如果f(r, y)是可分离的(可表示为(r)h(y))，那么一维技术可以用于每个维度。
&nbsp;&nbsp;&nbsp;&nbsp;回到我们之前的例子，假设我们从半径为R的圆盘上均匀采样，那么p(R，) = 1/(R")二维分布函数为
$$
Probability(r<r_0 ~and~ \theta < \theta_0) = F(r_0,\theta_0) =\int_{0}^{\theta_0}\int_{0}^{r_0}\frac{rdrd\theta}{\pi R^2}=\frac{\theta r^2}{2\pi R^2}
$$
&nbsp;&nbsp;&nbsp;&nbsp;这意味着规范对(1,2)可以转换为磁盘上的一个均匀随机点:
$$
\theta = 2\pi\varepsilon_1,\\
r = R\sqrt{\varepsilon_2}
$$
&nbsp;&nbsp;&nbsp;&nbsp;这个映射如图13.7所示。
&nbsp;&nbsp;&nbsp;&nbsp;为了在一些实际渲染应用中选择反射光线的方向，我们根据密度在单位半球上选择点:
$$
p(\theta,\phi) = \frac{n+1}{2\pi}cos^n\theta
$$
&nbsp;&nbsp;&nbsp;&nbsp;其中n是一个类峰指数，e是从表面法线和e10， π/2]的角度(在上半球)，o是方位角(e10, 2])。
累积分布函数为
$$
P(\theta,\phi)=\int_0^\phi\int_0^\phi p(\theta',\phi')sin\theta'd\theta'd\phi' \tag{13.8}
$$
sin e'项的出现是因为，在球面上da = cos eddo。当边际密度被发现时，p(如预期的)是可分离的，我们发现(€1,2)对规范随机数可以通过
$$
\begin{aligned}
&\theta = arccos((1+\varepsilon_1)^\frac{1}{n+1})\\
&\phi = 2\pi\varepsilon_2.
\end{aligned}
$$
&nbsp;&nbsp;&nbsp;&nbsp;同样，关于这个的一个很好的事情是，单位正方形上的一组抖动点可以很容易地转换为具有理想分布的半球上的一组抖动点。注意，如果n被设置为1，我们会得到一个弥散分布，这是经常需要的。
&nbsp;&nbsp;&nbsp;&nbsp;通常，我们必须根据uww基将球面上的点映射到一个适当的方向上。要做到这一点，我们首先可以将角度转换为单位向量:
$$
a= (cos\phi sin\theta,sin\phi sin\theta,cos\phi)
$$
&nbsp;&nbsp;&nbsp;&nbsp;为了提高效率，我们可以避免取反三角函数的三角函数(例如，cos (arccos9))。例如，当n = 1(一个扩散分布)时，向量a简化为
$$
a = (cos(2\pi \varepsilon_1)\sqrt{\varepsilon_2},sin(2\pi \varepsilon_1)\sqrt{\varepsilon},\sqrt{1-\varepsilon_2}) 
$$
#### 13.4.2拒绝
&nbsp;&nbsp;&nbsp;&nbsp;拒绝方法根据一些简单的分布选择点，并拒绝其中一些更复杂的分布。有几种使用拒绝的场景，我们通过示例展示其中一些。
&nbsp;&nbsp;&nbsp;&nbsp;假设我们想要单位圆内的均匀随机点。我们可以先选择均匀随机点(r, y) E[- 1,1]2，并拒绝圈外的点。如果函数r()返回规范随机数，则过程为
```
    one = false
    while (not done) do
        x = −1+2r()
        y = −1+2r()
        if (x2 + y2 < 1) then
            done = true
```
&nbsp;&nbsp;&nbsp;&nbsp;如果我们想要一个随机数r ~ p并且我们知道p: a,b r，并且对于所有r, p(r) < m，那么我们可以在矩形[a, bj x [0, m]中生成随机点并取y < p(r)的点:
```
    one = false
    while (not done) do
        x = a + r()(b − a)
        y = r()m
        if (y<p(x)) then
            done = true
```
&nbsp;&nbsp;&nbsp;&nbsp;同样的方法也可以应用到球体表面的任意点上。要选取一个方向分布均匀的随机单位向量，我们首先在单位球中选取一个随机点，然后取同方向的单位向量，将该点作为方向向量:
```
    done - false
    while (not done) do
        x = −1+2r()
        y = −1+2r()
        z = −1+2r()
        if ((l = squt(x*x + y*y + z*z) < 1) then
            done = true
    x = x/l
    y = y/l
    z = z/l
```
&nbsp;&nbsp;&nbsp;&nbsp;尽管拒绝方法通常编码简单，但它很少与分层兼容。由于这个原因，它往往收敛较慢，因此应该主要用于调试或在特别困难的情况下。
#### 13.4.3 Metropolis
&nbsp;&nbsp;&nbsp;&nbsp;Metropolis方法使用随机突变产生一组具有所需密度的样本。这个概念在本章注释中引用的Metropolis Light Transport算法中被广泛使用。假设在域s中有一个随机点ro。此外，假设对任意点z，我们有一种生成随机y ~ Pr的方法。我们使用边缘符号Pr (y) = p(z→y)来表示这个密度函数。现在，假设xi是S中的一个随机点，其潜在密度为p(xo→T1)。我们用密度p(r1→To)来生成r2，以此类推。在极限情况下，当我们生成无限个样本时，可以证明样本将有某个潜在密度由初始点ro决定。
&nbsp;&nbsp;&nbsp;&nbsp;现在，假设我们希望选择p，使我们收敛的样本的底层密度与函数f(r)成正比，其中f是一个具有定义域s的非负函数。此外，假设我们可以求f的值，但我们对f的性质几乎没有额外的知识(这类函数在图形中很常见)。同样，假设我们有能力进行从x到Ti+1的“过渡”，底层密度函数是t(a;→钛+ 1)。为了增加灵活性，进一步假设我们添加了潜在的非零概率z;转换到自身，即ri+1 = x。我们将其描述为生成一个潜在的候选y ~ t(Ti→y)。并且“接受”这个候选人(即Ti+1 = y)的概率为a(r;y)和拒绝它(即Ti+1 = r;)的概率为1-a(r;→y)。注意序列To, 1,22，....将是一个随机集合，但样本之间会有一些相关性。它们仍然适用于蒙特卡洛积分或密度估计，但分析这些估计的方差更具挑战性。
&nbsp;&nbsp;&nbsp;&nbsp;现在，假设我们有一个转换函数t(r→y)和一个函数f(z)我们想要模拟它们的分布，我们能不能用a(y→r)使点以f的形状分布?或者更准确地说,
$$
\lbrace x_0,x_1,x_2,\cdots \rbrace \approx \frac{f}{f_s f}.
$$
&nbsp;&nbsp;&nbsp;&nbsp;事实证明，这可以通过确保r在某种强意义上是静止的来实现。如果你想象一个巨大的样本点集合a，你希望两个点之间的“流”在每个方向上都是相同的。假设r和y附近点的密度分别与f(z)和f(y)成正比，那么两个方向的流量应该是相同的:
$$
flow(r \to y） = kf(z）t(z \to y）a(r \to y），\\
flow(y \to x） = kf(y）t(y \to x）a(y \to x），
$$
&nbsp;&nbsp;&nbsp;&nbsp;其中k是一个正常数。设置这两个flow常量对a有约束:
$$
\frac{a(y\to x)}{a(x\to y)} = \frac{f(x)t(x\to y)}{f(y)t(y\to x)}
$$
&nbsp;&nbsp;&nbsp;&nbsp;因此，如果a(y→z)或a(z→y)是已知的，另一个也是已知的。使它们变大可以提高被接受的机会，因此通常的技术是将两者中较大的那个设为1。
&nbsp;&nbsp;&nbsp;&nbsp;使用Metropolis样本生成技术的一个困难是，很难估计在点集“好”之前需要多少个点。如果丢弃前n个点，事情就会加速，尽管明智地选择n是不平凡的。
#### 13.4.4示例:在正方形中随机选择直线
&nbsp;&nbsp;&nbsp;&nbsp;作为设计采样策略的整个过程的一个例子，考虑寻找与单位正方形[0,1]2相交的随机线的问题。我们希望这个过程是公平的;也就是说，我们希望这些线在正方形内均匀分布。凭直觉，我们可以看出这个问题有些微妙之处;斜角的线条比水平或垂直方向的线条“更多”。这是因为正方形的横截面不均匀。
&nbsp;&nbsp;&nbsp;&nbsp;我们的第一个目标是找到一种函数反转方法(如果有的话)，如果失败了就求助于reject或Metropolis。这是因为我们希望在直线空间中有分层的样本。我们先试着用法坐标，因为在正方形中选择随机直线的问题就是在(r, 9)空间中任意与正方形中的直线对应的部分中找到均匀随机点的问题。
&nbsp;&nbsp;&nbsp;&nbsp;考虑-/2 <0 <0的区域。r的什么值对应于与正方形相交的直线?对于这些角度，r < cos9是所有撞击正方形的线，如图13.8所示。在其他四个象限中进行类似的推理，找到(r, 9)空间中必须采样的区域，如图13.9所示。该区域边界的方程Tmax(0)为
$$
r_{max}(\theta) = \begin{cases}
0 &if \quad \theta \in[-\pi,-\frac{\pi}{2}], \\
cos\theta &if \quad \theta \in[-\frac{\pi}{2},0], \\
\sqrt{2}cos(\theta-\frac{\pi}{4}) &if \quad \theta \in[0,\frac{\pi}{2}], \\
sin\theta &if \quad \theta \in[\frac{\pi}{2},\pi], \\
\end{cases}
$$
&nbsp;&nbsp;&nbsp;&nbsp;因为Tmax(9)下面的区域是一个以r = 0为界的简单函数，我们可以根据密度函数先选择9对其进行采样:
$$
p(\theta) = \frac{r_max(\theta)}{\int_{-\pi}^{\pi}r_{max}(\theta)d{\theta}}.
$$
&nbsp;&nbsp;&nbsp;&nbsp; 分母是4。现在，我们可以计算累计概率,分布函数:
$$
p(\theta) = \begin{cases}
0 &if \quad \theta \in[-\pi,-\frac{\pi}{2}], \\
(1+sin\theta)/4 &if \quad \theta \in[-\frac{\pi}{2},0], \\
(1+\sqrt{2}cos(\theta-\frac{\pi}{4}))/2 &if \quad \theta \in[0,\frac{\pi}{2}], \\
(3-cos\theta)/4 &if \quad \theta \in[\frac{\pi}{2},\pi], \\
\end{cases}
$$
我们可以通过将ξi = P(0)转化为0 = g(ξi)的形式来求这个值。这个收益率
$$
\theta = \begin{cases}
arcsin(4 \varepsilon_1) &if \quad \varepsilon_1 < \frac{1}{4}, \\
arcsin(\frac{\sqrt{2}}{2}(2\varepsilon_1-1)+\frac{\pi}{4} &if \quad \varepsilon_1 \in [\frac{1}{4},\frac{3}{4}] \\
arcsin(3-4 \varepsilon_1) &if \quad \varepsilon_1 > \frac{3}{4}. \\
\end{cases}
$$
一旦我们有$\theta$，那么r就是简单的
$$
r= \varepsilon_2r_{max}(\theta).
$$
&nbsp;&nbsp;&nbsp;&nbsp;如前所述，这条线有许多参数化，每一个都有一个相关的“公平”度量。我们也可以在这些空间中生成随机线。例如，在斜截空间中，击中正方形的区域如图13.10所示。通过与正规空间相似的推理，斜率的密度函数为
$$
p(m)=\frac{1+|m|}{4}
$$
&nbsp;&nbsp;&nbsp;&nbsp;微分方式为：
$$
d_{\mu} = \frac{dm}{(1+m^2)^{\frac{3}{2}}}
$$
&nbsp;&nbsp;&nbsp;&nbsp; 这就得到了累积分布函数:ifm <0，
$$
P(m) = \begin{cases}
\frac{1}{4}+\frac{m+1}{4\sqrt{1+m^2}} & if\quad m<0,\\
\frac{3}{4}+\frac{m-1}{4\sqrt{1+m^2}} & if\quad m\leq0.
\end{cases}
$$
&nbsp;&nbsp;&nbsp;&nbsp; 这些可以通过求解两个二次方程得到。给定用fi生成的m，我们有
$$
b = \begin{cases}
(1-m)\varepsilon_2 &if \qquad \varepsilon<\frac{1}{2}\\
-m+(1+m)\varepsilon_2 &otherwise
\end{cases}
$$
&nbsp;&nbsp;&nbsp;&nbsp;这并不比使用法坐标更好,只是另一种方式。

***
### FQA
+ 本章讨论的是概率，而不是统计。区别是什么?
概率是研究一个事件发生的可能性。统计学推论出大量但有限的随机变量群体的特征。从这个意义上说，统计可以被看作是应用概率的一种特定类型。
+ Metropolis抽样与Metropolis Light Transport算法相同吗?
不。都市轻轨运输(Veach & guopers, 1997)。算法使用Metropolis采样作为其过程的一部分，但它是专门用于渲染的，它还有其他步骤。

***
### 笔记
&nbsp;&nbsp;&nbsp;&nbsp; 几何概率的经典参考是几何概率(几何概率，所罗门，1978)。在超抽样模式的随机边缘差异(Dobkin & Mitchell，1993)。更多关于图形的准蒙特卡罗方法的信息可以在高效多维抽样(Kollig & Keller, 2002)中找到。三本关于蒙特卡罗方法的经典且可读性很强的书是蒙特卡罗方法(Hammersley & Handscomb, 1964)，蒙特卡罗方法，基础(Kalos &Whitlock, 1986)和蒙特卡洛方法(Sobel, Stone， & Messer, 1975)。

***
### 练习
1. 函数xyz在单位立方体$(x,yz)\in[0,1]^3$中的平均值是多少?
2. 单位半径圆盘上r的平均值是多少:$(\gamma,\phi)\in [0,1]*[0,2\pi]$?
3. 证明正则随机点(ξ1， ξ2)到任意三角形的质心坐标的一致映射为:$\beta=1-\sqrt{1-\varepsilon_1}, \gamma=(1-u)\varepsilon_2$.
4. 单位方格内直线的平均长度是多少?通过在单位方格中生成1000万条随机直线并对它们的长度取平均值来验证你的答案。
5. 单位立方体内的线的平均长度是多少?通过在单位立方体中生成1000万条随机线并平均它们的长度来验证您的答案。
6. 从方差的定义可以看出$V(x)=E(x^2)-[E(x)]^2$.
