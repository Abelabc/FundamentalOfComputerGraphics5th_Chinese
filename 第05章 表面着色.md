
*边学边翻译，督促自己不能落下，同时也留点记忆*

# <center>**第五章 表面着色**</center> 

***
&nbsp;&nbsp;&nbsp;&nbsp;当我们渲染3D场景的图像时，无论是使用射线跟踪还是光栅化，实时还是批处理，三维视觉表现的关键功能之一是，根据场景中的表面形状及其与场景中其他物体的关系为其着色。在物理世界中，我们看到的大部分光都是反射光，而光反射的物理属性受到几何的强烈影响，这产生了各种各样的细节信息，人类的视觉系统非常有效地利用这些细节信息来理解物体形状。
&nbsp;&nbsp;&nbsp;&nbsp;在计算机图形学中，着色的目的是为视觉系统提供这些细节，但具体目的取决于应用程序。在计算机辅助设计或科学可视化中，重点在于清晰度:着色设计应该提供最清晰、最准确的3D形状物体。在动画、虚拟环境或游戏中，目标介于两者之间:着色是为了达到艺术目的，包括描述形状和材料，但不一定是为了模仿现实。
&nbsp;&nbsp;&nbsp;&nbsp;用于计算着色的方程被称为着色模型，实际应用中，针对不同的应用，开发了一系列不同的着色影模型。一般来说，它们都从简单的模型开始，这些模型为光反射物理学提供了近似的模拟。随后，不断的加入新的功能，使得更接近物理的真实渲染，或者修改部分模型，使得更适合抽象的风格。
&nbsp;&nbsp;&nbsp;&nbsp;着色模型与渲染系统的其他部分是完全独立的，同样的模型可以用于光线跟踪和光栅化系统。本章描述了点光源照射下不透明表面的基本着色模型。这个模型可虽然简单，但包含了着色模型的基本，形成了更高级的着色计算（如第14章）的起点。

***
### 5.1 点类光源
&nbsp;&nbsp;&nbsp;&nbsp;在现实世界中，光线从各个方向照射到物体表面。但对于模仿照明，最简单的情况是光从一个方向到达表面。这太理想化了，但他却为那些在场景中占比较少的光源提供了一个有用的模型，这些光源要么确实很小(例如LED手电筒)，要么距离非常远(例如太阳)。点状光源有两种形式:点光源小到可以当作点来对待，但又靠近场景，能以不同的方式照亮不同的表面;定向光源既足够小(相对于它的距离)，可以被看作是点状的，又足够远，它照亮所有的表面都是一样的，而且不需要跟踪它的位置，只需要跟踪它的方向。手电筒和太阳是这两种光源的典型例子。
### 5.1.1 点状照明
&nbsp;&nbsp;&nbsp;&nbsp;一个点光源由它的位置（3D空间中的一个点），它的强度（描述他产生的光亮）组成。点光源可以是各向同性(所有方向上的强度都一样)；许多系统提供只向某些方向发送光的“聚光灯”，这可以方便地控制虚拟场景中的光，就像真正的聚光灯用于控制舞台上的光一样。
&nbsp;&nbsp;&nbsp;&nbsp;对于各向同性点光源，很容易推断出在一定距离外的表面上有多少光。假设我们有一个点源，发射辐射功率为1瓦的各向同性光，把光源放在一个空心球的中心，半径为1米(图5.1)。所有来自光的能量都落在球体的内表面上，并且均匀地分布在面积为$4\pi m^2$的整个球体上，因此每单位面积的辐射强度为$\pi/4$瓦特每平方米。irradiance(辐照度) 代表密度，描述多少光打到一个反射物体表面。
&nbsp;&nbsp;&nbsp;&nbsp;通常，对一个强度为p，接收球面半径为r的点光源来说，E为表示irradiance(辐照度) 
$$
\begin{align}
E=\frac{P}{4\pi}\frac{1}{r^2}=\frac{I}{r^2} \tag{5.1}
\end{align}
$$
&nbsp;&nbsp;&nbsp;&nbsp;$I=P/(4\pi)$是源的强度;这是光源的特性，与它所照亮的表面无关。$r^2$因子，通常称为平方反比项，描述irradiance(辐照度) 如何依赖于光源和表面之间的距离r。
&nbsp;&nbsp;&nbsp;&nbsp;计算irradiance(辐照度)另一个重要的考虑因素是入射角，即表面法线与光线传播方向之间的夹角。考虑一个小的表面，被一个相对于表面的大小是很远的点光源照亮。落在表面的光几乎都是平行传播的。如果我们将表面倾斜到图5.2所示的$60^0$的角度，表面只拦截了它面对光源时的一半光。一般来说，当旋转角度$\theta$时，它拦截了与$cos\theta$成正比的光量(辐射功率)，由于面积保持不变，irradiance(辐照度)(记住，是单位面积的辐射功率)与相同的因子成正比。这个定律，即表面的辐照度随入射角的余弦值递减，被称为兰伯特余弦定律，由约翰·海因里希·兰伯特在他1760年的《光度法》一书中描述的。
&nbsp;&nbsp;&nbsp;&nbsp;把上面结论导入到公式(5.1)我们得到了点光源辐照度的一般公式
$$
\begin{align}
E=I\frac{cos\theta}{r^2} \tag{5.2}
\end{align}
$$
&nbsp;&nbsp;&nbsp;&nbsp;$\cos\theta/r^2$叫做一个点光源的几何因子。他依赖光源和接收表面，但不依赖两者的其他属性。
&nbsp;&nbsp;&nbsp;&nbsp;实际应用中,$\theta$角通常不用计算,因为表面的单位法线向量和光线的方向向量,cos因子使用点乘计算出来:
$$
cos\theta = n*l
$$
&nbsp;&nbsp;&nbsp;&nbsp;这比使用三角函数计算更简单和有效。
### 5.1.2 定向照明
&nbsp;&nbsp;&nbsp;&nbsp;定向源是一种非常明亮，且无限远的光源。随着光源越来越远，公式5.2中的比值$I/r^2$在场景中变化越来越小，对于定向光源，我们将其替换为一个常数,H：
$$
E= Hcos\theta
$$
&nbsp;&nbsp;&nbsp;&nbsp;常数可以称为normal irradiance(法向辐照度)，因为它等于光沿表面法线定位时的辐照度。定向光有以下特征：朝向光源的方向(而不是位置)、法线辐照度H(而不是强度)，照明是均匀的（不像点源照明那样随距离而衰减）。

***
### 5.2 基本反射模型
&nbsp;&nbsp;&nbsp;&nbsp;现在，我们可以计算irradiance(辐照度)，来描述有多少光打到了物体表面，另外一个问题是物体如何反射光线。这取决于对象的材质，在本章中，我们引入了一个可选光泽表面的颜色材料的基本模型。如图5.4所示:材质有一个决定物体整体颜色的基础层，它提供一个光泽的、带镜面反射的表面，下面讲分别讲述最简单的模型。
#### 5.2.1 兰伯特反射
&nbsp;&nbsp;&nbsp;&nbsp;最简单的反射是，一种表面，不管光线从哪里来，它都能向各个方向均匀地反射光线，所以观察者看到的反射光$L_r$只是辐照度的常数倍:
$$
L_r= kE \tag{5.3}
$$
&nbsp;&nbsp;&nbsp;&nbsp;展现出这种特性的表面被称为理想扩散表面，它从各个方向看都具有相同的亮度;它的颜色与视图无关，完全由它的反射率R描述，R是它反射的辐照度的一部分。与入射光有关的反射光系数是R/π(第14章将解释产生π的原因)
$$
\begin{aligned}
L_r=\frac{R}{\pi}E
\end{aligned}
$$
&nbsp;&nbsp;&nbsp;&nbsp;对于不同颜色的光，反射率可能是不同的。对于简单的颜色建模，只要保持三种不同的反射率就足够了，红、绿、蓝各一个，所以着色方程对三种颜色通道分别计算。
&nbsp;&nbsp;&nbsp;&nbsp;理想的漫反射着色，通常被称为兰伯特着色，因为兰伯特余弦定律是模型的主要影响因素，它本身就提供了一个普通、清晰的表现。在物理上，它模拟了光照与内部被包围的材质的交互，反射随机地在各个方向发生。这是一个有效的模型，纸，平面油漆，污垢，树皮，石头，以及那些粗糙的、没有确切和光滑的顶部表面材质，这些材质不能产生明显的光泽反射。
#### 5.2.2 镜面反射
&nbsp;&nbsp;&nbsp;&nbsp;许多材质都有一定程度的光泽，例如，金属、塑料、光泽或半光泽涂料，或许多植物的叶子。当看这些材质时，你会看到当移动视点时，反射会四处移动。你可以使用与兰伯特曲面无关的方法，来描述的这种随视点变化的色彩。这种与视点相关的反射通常发生在材料的顶部表面，被称为镜面反射。
&nbsp;&nbsp;&nbsp;&nbsp;最简单的镜面反射发生在像镜子或水面这样非常光滑的表面上:光以镜面的方式反射，所以来自点源的光只朝着一个方向反射。这就是所谓的理想镜面反射，通常需要作为特殊情况来处理。但许多表面并不是完全光滑的，它们表现出一种更普遍的反射，在计算机图形学中称为光滑反射。有许多光滑反射的模型，第14章将进一步讨论。但是一个简单而著名的模型最初是由Phong(1975)提出的，随后由Blinn(1976)和其他人加以改正，形成了现在最常用的$Blinn-Phong$模型。
&nbsp;&nbsp;&nbsp;&nbsp;由于镜面反射依赖于视图，所以它是一个视图向量v（从着色点指向观察者），以及法向量n和光方向l的函数。当v和l对称地分布在表面法线两侧时，会产生最亮的反射,此时就发生了镜面反射。然后，当矢量远离镜像构造时，反射平滑地减少。
&nbsp;&nbsp;&nbsp;&nbsp;我们可以使用半向量的概念来判断我们与镜面构型的距离有多近，半向量是观察方向和照明方向之间的中间向量，当I和v处于镜面反射构型中时，它正好垂直于镜面表面(图5.5)。如果半向量接近表面法线，则镜面分量应该是明亮的;我们通过计算h和n的点积(记住它们是单位向量，所以当向量相等时n.h达到最大值1)来衡量它们的接近度，然后将结果取幂p > 1，以使其减小得更快:
$$
\begin{aligned}
（n*h）^P
\end{aligned}
$$
&nbsp;&nbsp;&nbsp;&nbsp;Phong指数p控制表面的表观光泽:数值越高，使得反射随着远离镜子的方向下降地越快，导致更闪亮的外观。半向量很容易计算:由于v和I的长度相同，它们的和是一个平分它们之间的夹角的向量，只需要标准化就可以得到h:
$$
\begin{aligned}
\frac{l+v}{\begin{Vmatrix}l+v\end{Vmatrix}}
\end{aligned}
$$
&nbsp;&nbsp;&nbsp;&nbsp;为了将Blinn-Phong的思想融入到着色计算中，我们在兰伯特着色中添加了一个镜面组件;兰伯部分就是漫反射部分。我们简单地归纳了(5.3)中有关反射光与入射辐照度的因子k，它不仅包括漫反射的贡献，还包括一个单独的加入了镜面反射的项。
$$
\begin{aligned}
L_r =（\frac{R}{\Pi}+k_sMax(0,n*h)^p)E
\end{aligned}
$$
&nbsp;&nbsp;&nbsp;&nbsp;这里的比例因子$k_s$是镜面系数(红色，绿色和蓝色分开)，控制镜面分量的亮度，我们增加了一个箝位操作，以避免在n与h的大于90度的情况下出现意外。
&nbsp;&nbsp;&nbsp;&nbsp;因子k称为双向反射率分布函数或BRDF，因为它描述反射率如何作为I和v两个方向的函数变化。兰伯表面的BRDF是恒定的，而镜面反射的表面的BRDF不是恒定的。因此，着色计算归结为计算辐照度(描述有多少光可以反射)和BRDF(描述表面如何反射)，然后将它们相乘。第14章对BRDF，有更完整的讨论。
#### 5.2.3 着色计算
&nbsp;&nbsp;&nbsp;&nbsp;在实现表面着色时，代码需要访问光源、表面和视线方向的信息。通过将irradiance(辐照度)的计算与反射光的计算分开，使得编写支持点光与方向光的代码分开。辐照度只取决于光源和表面几何形状，一旦知道，计算反射光只取决于表面性质和观测物体的几何形状。
&nbsp;&nbsp;&nbsp;&nbsp;基本的着色计算可以在光线跟踪和光栅化系统中以完全相同的方式完成;只是计算输入的方式不同。要计算辐照度，我们需要:

+ 着色点x，在一个表面的3D坐标点。
+ 表面法线，在x点垂直于表面。
+ 点光源的位置p或平行光线里的光线方向。
+ 点光源中的光源强度I或方向光源中的法向辐照度H（区分RGB颜色）。
  
&nbsp;&nbsp;&nbsp;&nbsp;对一个点光源，我们需要计算距离和光源方向，这两种都比较容易从矩阵p-x获得：
$$
\begin{aligned}
r = \begin{Vmatrix}p-x\end{Vmatrix}，I=\frac{p-x}{r}
\end{aligned}
$$
&nbsp;&nbsp;&nbsp;&nbsp;对于这两种类型的光，余弦因子最好使用点积计算;其中要求n和l是单位向量，
$$
\begin{aligned}
cos\theta = n*l
\end{aligned}
$$
&nbsp;&nbsp;&nbsp;&nbsp;在实践中，当计算辐照度时，将点积固定在零是一个好主意，以确保即使在某些情况下，光的方向远离表面法线，也不会得到负着色。这就得到了计算辐照度的正式方程:
$$
\begin{aligned}
E=\frac{max(0,n*l)}{r^2}I (点光源) or max(0,n*l)H(方向光)
\end{aligned}
$$
&nbsp;&nbsp;&nbsp;&nbsp;一旦知道了辐照度，它需要乘以BDRF值。计算该值的步骤为：

+ 光的方向l，一个从x指向光的单位向量 (已作为辐照度计算的一部分计算)
+ 观看方向v，一个从x指向观看者的单位向量.
+ 描述表面材料性能的参数。对于本章的模型，包括R, $k_s$和p

&nbsp;&nbsp;&nbsp;&nbsp;在光线追踪和光栅化系统之间，获取这些量的方式有很大的不同，但实际的着色计算是相同的。记住v、l和n都必须是单位向量;在着色计算中，没有规范化这些向量是一个非常常见的错误。
***
### 5.3 境照明
&nbsp;&nbsp;&nbsp;&nbsp;点状光源是一个非常局部化的光源模型，它在一个方向附近产生大量光。其他种类的光源就不那么局限了，比如天空，或者房间墙壁反射的光。当对这些扩展的光源非常详细地建模，使用基本着色时，我们需要一个非常可靠的估算，所以我们假设场景中所有方向和位置的环境光都完全相同(图5.6)。我们进一步假设环境光只是漫反射(因为没有光的方向，因此没有办法计算镜面着色)。这使得环境着色非常简单:它是一个常量!
&nbsp;&nbsp;&nbsp;&nbsp;通常，这个常数被分解成一个材质相关的环境反射影响影子$k_a$和一个与光源相关的环境强度$I_a$:
$$
L_r = k_a*I_a
$$
&nbsp;&nbsp;&nbsp;&nbsp;这两个量都是有颜色的，所以它们分别相乘(红色的环境系数是红色的环境强度)。这样可以方便地调整每个对象和整个场景中的环境着色。
&nbsp;&nbsp;&nbsp;&nbsp;环境阴影有点黑科技，因为来自大型光源的光照仍然不同:它往往在角落和其他凹区域更暗。但它是简单着色设定的重要成分，因为它可以防止阴影完全变黑，并允许一种简单的方法来调整整体场景对比度
&nbsp;&nbsp;&nbsp;&nbsp;许多系统将环境光作为一种光源，与点光源和方向光一起并列；而其他系统将环境强度作为场景的参数，没有明确的环境光源，这与假设只有一个环境光是一样的。
***
### FAQ
+ Phong着色似乎是一个巨大的科技。这是真的吗?
&nbsp;&nbsp;&nbsp;&nbsp;是的。如果你试图匹配真实表面的测量结果，Phong着色不是一个很好的模型。然而，它是简单的，并已证明是一个非常实用的产生着色的方法。寻找真实阴影的应用正在从Phong阴影转向基于微观面理论的更复杂但更精确的模型(Walter, Marschner, Li，&Torrance, 2007)。但真实感也需要比点状光源做的更多。所有这些都在第14章里。
+ 我讨厌调用pow()。在做Phong光照时，有没有办法避免它?
&nbsp;&nbsp;&nbsp;&nbsp;一个简单的处理方法是，指数本身是2的幂，如：2,4,8,16，. . . 实际上，对于大多数应用程序来说，这不是一个有问题的限制。许多用于快速图形计算的系统都有用于pow()库函数，这些库函数比标准数学库中的函数快得多，但精度略低。
***
### 练习
+ 1.月亮在漫反射和Phong着色下都与现实相差较远。什么观察结果告诉你这是真的?
+ 2.天鹅绒在漫反射和Phong着色都不理想。什么观察结果告诉你这是真的？
+ 3.为什么大多数塑料制品的高光看起来是白色的，而金色金属品的高光看起来是金色的？
