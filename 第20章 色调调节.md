*边学边翻译，督促自己不能落下，同时也留点记忆*

# <center>**第二十章 色调调节**</center> 
正如在第19章中所讨论的，人类的视觉系统能适应广泛的观看条件。在正常观察下，我们可以分辨出大约4到5个对数单位的照度范围，也就是说，我们可以看到细节的最亮和最暗区域之间的比例可能高达100,000:1。通过适应过程，我们可以适应更大范围的光照。我们把与人类视觉系统能力相匹配的图像称为高动态范围。
视觉模拟通常产生高动态范围的图像(Ward Larson & Shakespeare, 1998)。图像捕捉技术的最新发展允许多次曝光对齐并重新组合成单一的高动态范围图像(Debevec & Malik, 1997)。多重曝光技术也适用于视频。此外，我们希望未来的硬件能够直接拍摄或拍摄高动态范围的场景。一般来说，我们可以把每个像素看作三个浮点数的三元组。
随着创建高动态范围图像变得越来越容易，显示这类数据的需求也在迅速增加。不幸的是，大多数当前的显示设备，显示器和打印机，只能显示大约2 log单位的动态范围。我们认为这种装置的动态范围很低。目前存在的大多数图像都是用每字节每像素每颜色的通道来表示的，它与当前的显示设备相匹配，而不是与它们所代表的场景相匹配。
通常，低动态范围的图像不能在不丢失信息的情况下表示场景。一个常见的例子是一个有出口的室内房间通过窗户可以看到门区域。人们很容易看到室内和室外的细节。传统的照片通常不能捕捉到这一系列的信息，摄影师必须选择是适当地暴露在室内还是室外的场景(见图20.1)。这些决定可以通过使用高动态范围成像和使用本章描述的技术准备这些图像来避免(见图20.2)。
有两种策略可用于显示高动态范围的图像。首先，我们可以开发可以直接适应高动态范围的显示设备(Seetzen, Whitehead， &
病房里,2003;Seetzen等人，2004)。其次，我们可以准备高动态范围的图像，以便在低动态范围的显示设备上显示(Upstill，
1985)。这是目前比较常见的方法，也是本章的主题。尽管我们预见到了这个高度
图20.2。高动态范围图像
使用最近的音调re显示的音调映射
动态范围显示设备将成为生产操作员(Reinhard & Devlin, 2005)。
在(不久的)将来被广泛使用，
在这张图中，室内部分和透过窗户的景色都被适当地暴露出来。
压缩图像动态范围的需要可能会减少，但不会减少
消失。特别是像这本书这样的印刷媒体，就其本质而言，是低动态范围的。
为了在低动态范围显示设备上显示而压缩图像值的范围称为音调映射或音调再现。一个简单的压缩函数是将图像规范化(参见图20.3(左))。这构成了一个线性缩放，只有当图像的动态范围仅略高于显示设备的动态范围时，它才趋于充分。对于具有较高动态范围的图像，小的强度差异将被量化到相同的显示值，这样可见的细节就会丢失。
在图20.3(中间)中，所有大于用户指定最大值的像素值都被设置为这个最大值(即，它们被夹紧)。这使得归一化较少依赖于噪声异常值，但在这里我们丢失了图像明亮区域的信息。为了进行比较，图20.3(右)是一个色调映射版本，显示了暗区域和亮区域的细节。
一般来说，线性缩放不适合于色调复制。在色调复制的关键问题是压缩图像，同时保留图像的一个或多个属性。不同的色调复制算法关注不同的属性，如对比度、可见细节、亮度或外观。
理想情况下，在低动态范围显示设备上显示声调映射图像将在观察者中产生与原始场景相同的视觉响应。
鉴于显示设备的局限性，这是不可能实现的，尽管我们可以尽可能接近这一目标。
作为一个例子，我们创建了如图20.4所示的高动态范围图像。然后将图像进行声调映射，并在显示设备上显示。
然后将显示设备本身放在场景中，这样它就可以显示自己的背景(图20.5)。在理想情况下，显示器应该是透明的ent。取决于色调再现操作器的质量，以及被描绘的场景的性质，这个目标或多或少是可以实现的。
20.1分类
尽管可以根据音调再现操作符的目的是保留什么属性，或者它们是为什么任务而开发的来对它们进行分类，但我们还是根据它们的一般技术来对算法进行分类。这将使我们能够显示大量不同操作符之间的差异和相似之处，因此，希望有助于为给定的音调复制任务选择有意义的特定操作符。
我们遵循的主要分类方案取决于这样一种认识，即音调再现运算符是基于从不同学科获得的见解。特别是，一些运算符是基于人类视觉感知的知识。
人类的视觉系统通过位于视网膜上的感光器来探测光线。光被转换成电信号，部分经过视网膜处理，然后传输到大脑。除了视网膜上最初的几层细胞外，被探测到的光所产生的信号都是通过脉冲序列来传输的。信息携带量是这些电脉冲发生的频率。
人类视觉系统所能探测到的光的范围远远大于人类大脑用来传输信息的频率范围。因此，人类视觉系统毫不费力地解决了色调再现问题——将大范围的亮度转换为小范围的脉冲序列频率。因此，模拟人类视觉系统的相关方面是一种有价值的音调复制方法;这种方法在第20.7节中有更详细的解释。第二类算符以物理学为基础。光在被光感受器吸收之前与表面和体积相互作用。在计算机图形学中，光的相互作用通常用渲染方程来建模。对于纯漫射表面，这个方程可以简化为入射到表面的光(照度)与该表面的反射光能力(反射率)之间的乘积(Oppenheim, Schafer， & Stockham, 1968)。
由于反射率是表面的被动属性，对于漫反射表面，根据定义，它是低动态范围-通常在0.005到1之间(Stockham，
1972)。一个表面的反射率不能大于1，因为这样它反射的光会比入射到表面上的光多。另一方面，照度可以产生任意大的值，只受光源的强度和接近程度的限制。
因此，图像的动态范围主要由照度分量决定。面对漫反射的场景，一种可行的色调复制方法可能是将反射率从照度中分离出来，压缩照度分量，然后重新组合图像。
然而，假设场景中的所有表面都是扩散的通常是不正确的。许多高动态范围图像描述高光和/或直接可见光源(图20.3)。镜面反射的亮度可能几乎与它反射的光源一样高。
目前使用的各种色调再现算子将图像分为高动态范围的基本层和低动态范围的细节层。如果所描绘的场景完全弥漫，这些层将代表照度和反射率。对于包含直接可见光源或镜面高光的场景，分离成基本层和细节层仍然允许有效的色调再现操作符的设计，尽管不能将直接的意义附加到单独的层。这些操作符将在第20.5节中讨论。
20.2动态范围
传统的图像存储为红、绿、蓝三种成分，每像素一个字节。这种编码所提供的动态范围取决于最小和最大可表示值之间的比值，以及连续值之间的步长。因此，对于低动态范围的图像，每个颜色通道只有256个不同的值。
高动态范围图像编码的可能值明显更大;可表示的最大值可能要大得多，而连续值之间的步长可能要小得多。文件大小动态高因此，范围图像通常也更大，尽管至少有一个标准(OpenEXR高动态范围文件格式(Kainz, Bogart， & Hess, 2003)包含一个非常强大的压缩方案。
限制文件大小的另一种方法是对高动态数据应用音调再现运算符。然后可以将结果编码为JPEG格式。此外，输入图像可按像素被声调映射图像分割。
这种划分的结果可以被下采样，并作为少量数据存储在同一JPEG图像的标题中(G. Ward & Simmons, 2004)。这种子带编码图像的文件大小与传统的JPEG编码图像的顺序相同。显示程序可以直接显示JPEG图像，也可以通过将声调映射图像与存储在标头中的数据相乘来重建高动态范围图像。
一般来说，最小步长和最小和最大可表示值之比的组合决定了图像编码方案提供的动态范围。对于计算机生成的图像，在将图像写入文件或显示在屏幕上之前，通常将图像存储为浮点值的三元组，尽管有更有效的编码方案(Reinhard, Ward, Debevec， & Pattanaik, 2005)。由于大多数显示设备仍然配备了八位D/A转换器，我们可以将音调再现视为浮点数到字节的映射，这样结果就可以在低动态范围显示设备上显示。
单个图像的动态范围通常较小，由场景中发现的最小和最大亮度决定。因此，一种测量图像动态范围的简单方法可以计算图像最大像素值和最小像素值之间的比值。通过忽略一小部分最暗和最亮的像素，可以降低对异常值的敏感度。
同样的比值也可以表示为对数域中的差值。这种方法对异常值不太敏感。本页页边空白处显示的图像是具有不同动态范围的图像示例。注意，在这种情况下，夜景的动态范围并不比白天的小。虽然夜景中所有的值都变小了，但最大值和最小值的比值却没有变小。
然而，记录设备或渲染算法可能会引入噪声，从而降低有用的动态范围。因此，对图像动态范围的测量应考虑噪声因素。因此，更好的测量动态范围的方法是用信号处理中使用的以分贝表示的信噪比。20.3颜色
色调再现操作符通常压缩亮度值，而不是直接处理彩色图像的红色、绿色和蓝色组件。在这些亮度值被压缩成显示值La(a, y)后，可以通过保持颜色通道之间的比例与压缩前相同(使用s = 1)来重建彩色图像(Schlick, 1994b):
Ir, d (r、y)
＝
（）
(和),
Ig，d（z， y）
（）
La（z， y），
Ib, d (y, z)
＝
（）
La (x、y)。
结果经常出现过饱和，因为人类的颜色感知是非线性的，相对于整体亮度水平。这意味着，如果我们在昏暗的环境中观看显示器上明亮的户外场景，我们的眼睛会适应昏暗的环境，而不是室外照明。通过保持颜色比例不变，我们没有考虑到这种影响。
或者，饱和常数s可以选择小于1。这样的每通道伽马校正可以使结果饱和度降低到适当的水平，如图20.11所示(Fattal, Lischinski， & Werman, 2002)。一种更全面的解决方案是将色彩外观建模领域的思想融入到色调再现操作中(Pattanaik, Ferwerda, Fairchild， & Greenberg, 1998;Fairchild & Johnson, 2004;Reinhard & Devlin, 2005)。最后，如果已经有具有代表性的配色方案的示例图像，则可以将该配色方案应用到新的图像上。这种图像之间的颜色映射可用于细微的颜色校正，如饱和度调整或更有创意的颜色映射。映射通过将源图像和目标图像转换到一个与颜色相关的空间来进行。在这样的颜色空间中，每个颜色通道中的像素值可以独立处理，而不引入太多工件(Reinhard, Ashikhmin, Gooch， & Shirley，
2001).
在与颜色相关的颜色空间中，将一个图像的颜色映射到另一个图像是很简单的:分别为三个颜色通道计算源图像和目标图像中所有像素的平均值和标准差。然后,
移动和缩放目标图像，以便
每个颜色通道的平均值和斯坦
目标图像的偏差为
与源图像相同。结果
然后通过变换得到图像
从无关的颜色空间
到RGB和夹紧负像素到
零。图像的动态范围
可能会因为申请的结果而改变
通过这个算法。因此，请重新查看图20.12。演示用图像
色彩转移技术。结果如下所示
改进了该算法的应用
在图21.13和21.31中。
动态范围图像，然后应用传统的色调再现算法。一个合适的与颜色相关的空间是18.2.4节中的对立空间。
对图20.12中的图像应用这种颜色变换的结果如图20.13所示。20.4图像形成
目前，我们假设图像是由光在表面上漫反射形成的。在第20.5节和20.6节中，我们将这种限制放宽到直接描述光源和高光的场景。每个像素的亮度L由以下乘积近似表示:
Lv (a, y) = r(z, y) Ev(z, y)
这里，r表示表面的反射率，E表示照度。下标u表示我们使用的是光度加权量。或者，我们可以把这个表达式写成对数定义域(Oppenheim
等，1968):
D(x, y) = log(Le (x, y))
= log () E (y r (r, r、y) = log (r (x, y) +日志(Ee) y (z,
摄影透明装置通过改变材料的密度来记录图像。
在传统摄影中，这种变化与亮度有对数关系。因此，与摄影中常见的做法类似，我们将使用术语密度表示(D)来表示对数亮度。当用对数域表示时，反射率和照度成为相加的。这促进了这两个组分的分离，尽管分离反射率或照度是一个限制不足的问题。实际上，分离只在一定程度上是可能的，并取决于图像的组成。尽管如此，色调复制可以基于图像形成的这两个组成部分的分离，如下面的两个部分所示。
20.5基于频率的运算符
对于典型的漫反射场景，由于纹理表面和表面边缘的存在，反射率分量倾向于显示高的空间频率。另一方面，照度在空间上趋向于一个缓慢变化的函数。
由于反射率是低动态范围，照度是高动态范围，我们可以尝试将这两个组成部分分离。反射率和照度的频率依赖性提供了一个解决方案。例如，我们可以计算图像的傅里叶变换，只衰减低频部分。这将压缩照度分量，同时保留反射率分量基本上不受影响——我们所知的第一个数字音调复制操作符采用了这种方法(Oppenheim et al.， 1968)。
最近，其他运营商也遵循了这一思路。特别地，使用双边和三边滤波器将图像分离为基本层和细节层(Durand & Dorsey, 2002;Choudhury & Tumblin, 2003)。这两个滤波器都是保边平滑算子，可以以各种不同的方式使用。对密度图像应用cdg - precrving平滑算子会得到一个模糊的图像，其中锋利的边缘仍然存在(图20.14(左))。我们可以把这样的图像看作基础层。如果我们按像素将高动态范围图像除以基本层，我们得到一个包含所有高频细节的细节层(图20.14(右))。
对于漫反射场景，基本层和细节层类似于照度和反射率的表示。对于描述亮点和光源的图像，
这种类比并不成立。然而,
将一幅图像分离成基片和基片
细节层是可能的，不管
图像的内容。通过压缩
将基层再组合成
压缩后的密度图像，低dy
纳米范围密度图像可以被应用
(图20.15)。exponentia后
则得到可显示的图像。
图20.15。用bi映射的图像色调
保边平滑操作侧滤波。基础层和细节层显示
在图20.14中被重新组合后，也可以使用压缩器来计算基层的局部计算。
每个像素的自适应水平，即
可用于空间变化或局部音调再现算子。我们将在第20.7节描述双边和三边过滤器的使用。20.6梯度域操作符
上一节中关于基于频率的算子的论证也适用于梯度场。假设没有直接可见的光源，反射率分量将是梯度场中带有尖峰的常数函数。同样，照度分量会在各处造成小的梯度。
在典型的场景中，人类通常能够区分照度和反射率。对光源折现后的表面反射率的感知称为明度。为了评估只描述漫反射表面的图像的亮度，B. K. P. Horn第一个使用梯度场分离反射率和照度(Horn, 1974)。他使用简单的阈值法去除所有小的梯度，然后对图像进行集成，这涉及到使用完全多重网格法求解Poisson方程(Press, Teukolsky, Vetterling， & Flannery, 1992)。
结果与保边平滑滤波器相似。这是根据预期，因为奥本海姆基于频率的算子在相同的场景反射率和图像形成的假设下工作。霍恩的作品直接针对的是“蒙德里安的迷你世界”，这是类似荷兰著名画家皮埃·蒙德里安(Piet Mondrian)抽象画的扩散场景的简化版本。
Horm的工作不能直接用作色调再现算子，因为大多数高动态范围图像描述光源。然而，一个相对小的变化将把这个工作变成一个合适的色调再现操作符。如果光源或镜面被描绘在图像中，那么大的梯度将与光源的边缘和高光相关联。这使得图像具有很高的动态范围。一个例子如图20.16所示，其中斯诺克球上的高光引起了尖锐的渐变。因此，我们可以通过衰减大的梯度来压缩高动态范围的图像，而不是阈值梯度场。Fattal等人采用了这种方法，他们表明通过集成压缩梯度场可以成功地压缩高动态范围图像(图20.17)(Fattal等人，2002)。Fattal的梯度域压缩是
图20.17。使用梯度域压缩映射的图像。
不限于漫景。
### 20.7空间算符
在接下来的小节中，我们将讨论直接对像素应用压缩而不转换到其他域的音调再现操作符。通常要区分全局和本地操作。前者中的色调复制操作符根据压缩函数改变每个像素的亮度值，压缩函数对每个像素都是相同的。术语全局来源于这样一个事实，即许多这样的函数需要锚定到通过分析完整图像确定的一些值。在实际操作中，大多数操作人员使用几何平均Le来控制压缩:
L = exp log(6 + Le(r, y))
(20.1)
在式(20.1)中，引入了一个小常数6，以防止在存在黑色像素时，平均值变为零。几何平均值通常映射到一个预定义的显示值。将几何平均值映射到不同显示值的效果如图20.18所示。或者，有时使用最小或最大的图像亮度。全局算符设计中面临的主要挑战在于压缩函数的选择。
另一方面，局部算子根据特定的压缩函数压缩每个像素，该压缩函数由来自相邻像素的选择的信息调制而成，而不是整个图像。其基本原理是，明亮区域内的明亮像素可能与昏暗区域内的明亮像素被感知到的不同。本地运营商发展中的设计挑战

***
### 练习

