*边学边翻译，督促自己不能落下，同时也留点记忆*

# <center>**第十四章 基于物理的着色**</center> 

***
&nbsp;&nbsp;&nbsp;&nbsp;虽然所有的渲染在某种程度上都是“基于物理的”，但“基于物理的”这个术语在实践中意味着我们将严格遵守物理模型，而不是“现象学的”，这是一种启发式地捕捉主观感知特征的方法，例如将突出点放在“正确”位置的经验公式。本章从高层次上介绍了基于物理的渲染，定义了该领域中使用的单位和术语，并提供了一种强力的“路径跟踪”算法，该算法可以非常缓慢地生成非常精确的图像。我们不深入研究许多渲染的细节。需要注意的是，效率的提升正是我们在电影和游戏中呈现逼真画面的原因，这是不容小觑的;我们不讨论这些细节，因为它们是一个移动的目标，在生态系统中有很好的报道，最著名的是法尔等人(2016)的优秀PBRT书籍和代码库。
***
### 14.1 光子
&nbsp;&nbsp;&nbsp;&nbsp;为了帮助我们的直觉，我们将从大量光子的集合的角度来描述辐射计量，这一节建立了在这种情况下光子的含义。请注意，在图形中，“光子”并不一定意味着它在物理中所做的事情，许多物理学家在阅读图形人员写的关于“光子跟踪”的讨论时感到困惑。对我们来说，光子是通常只是一个符合几何光学的能量包(光以直线传播，没有波的特性)。
&nbsp;&nbsp;&nbsp;&nbsp;更准确地说，光子是一束光，它有位置、传播方向和波长λ。有点奇怪的是，表示波长的国际标准单位是纳米(nm)。这主要是由于历史原因，1nm=$10^{-9}$米。有时也用另一个单位埃，一纳米等于十埃。光子的速度c也只取决于它所传播的介质的折射^-率n。有时频率f = c/λ也用于光。这很方便，因为与λ和c不同，当光子折射到具有新的折射率的介质中时，f不会改变。另一个不变的度量是光子携带的能量q，它由以下关系给出:
$$
q= hf=\frac{hc}{\lambda} \tag{14.1}
$$
其中h=6.63×10^{−34} Js为普兰克常数。虽然这些量可以在任何单位制中测量，但我们将尽可能使用国际单位制。
***
### 14.2 光滑金属
&nbsp;&nbsp;&nbsp;&nbsp;对于光滑的金属，光要么如4.5.4节所述镜面反射，要么折射到表面，然后迅速被吸收d (有了非常薄的金属涂层，就像有时做在玻璃上一样，你可以看到光一直穿过，而且金属实际上不是不透明的).反射光的量由菲涅耳方程决定。这些方程很简单，但很麻烦。此外，它们的值随光的偏振而变化，这是图形中通常忽略的特性。菲涅尔方程的主要视觉效应是反射率随着入射角的增加而增加，特别是在掠射角附近，反射率达到100%
&nbsp;&nbsp;&nbsp;&nbsp几乎所有的图形程序都使用Schlick(1994)开发的菲涅尔方程的简单近似。对于金属，我们通常指定在正入射R0(λ)处的反射率。反射率应该根据菲涅尔方程而变化，Schlick(1994)给出了一个很好的近似
$$
R(\theta,\lambda)=r_0(\lambda)+(1-r_0(\lambda))(1-cos\theta)^5
$$
&nbsp;&nbsp;&nbsp;&nbsp;θ是光传播方向与表面法线之间的夹角。在这里，这种近似允许我们仅仅通过数据或肉眼设置金属的正常反射率。

***
### 14.3 光滑的电介质
&nbsp;&nbsp;&nbsp;&nbsp;电介质是折射光的透明材料，如果它们不是金属，它们就是电介质，这是一个不错的启发。因此，皮肤、牛奶、头发、布料以及几乎所有的日常材料都是介电材料，尽管这并不明显，因为它们是不同折射率和吸光杂质的混合物，所以往往是不透明的。但光滑的均匀介质是透明的，例如玻璃、水和眼睛中的晶状体。对于光滑的电介质，只有三个重要的特性：
1. 每个入射角和波长反射多少光进
2. 在一定的距离和波长下，光在穿过材料时被吸收的比例是多少?
3. 反射光和折射光的方向是什么?
#### 14.3.1 介质的反射率
&nbsp;&nbsp;&nbsp;&nbsp;光如何几何弯曲以及反射/透射的比例取决于材料的折射率n(λ)。对于电介质，同样是施里克反射率的公式14.2与金属的原理相同。然而，当其中一种材料是空气时，我们可以将R0(λ)表示为n(λ
$$
R_0(\lambda) = \left(\frac{n(\lambda)-1}{n(\lambda)+1}\right)^2
$$
&nbsp;&nbsp;&nbsp;&nbsp;在方程两边折射率都不是1.0的情况下(如空气或真空)，那么这个公式适用
$$
R_0(\lambda) = \left(\frac{n_t(\lambda)-n_i(\lambda)}{n_t(\lambda)+n_i(\lambda)}\right)^2
$$
&nbsp;&nbsp;&nbsp;&nbsp;通常情况下，n不随波长变化，但对于色散(不同波长彼此分散，我们得到彩虹)很重要的应用，n可以变化。通常有用的折射率包括水(n = 1.33)，玻璃(n = 1.4到n = 1.7)，钻石(n = 2.4)
&nbsp;&nbsp;&nbsp;&nbsp;透射的光量是没有反射的光量(这是能量守恒的结果)。因此，我们不需要明确计算传输裂缝的公式
#### 14.3.2折射和比尔定律
&nbsp;&nbsp;&nbsp;&nbsp;电介质还可以过滤和折射光线;有些玻璃过滤掉的红光和蓝光多于绿光，所以玻璃呈现出绿色的色调。当光线从折射率为n的介质传播到折射率为nt的介质中时，会有一部分光被透射出去，并发生弯曲。图14.1中显示了forn > n。斯涅尔定律告诉我们
$$
n~sin\theta = n_tsin\phi
$$
&nbsp;&nbsp;&nbsp;计算两个向量夹角的正弦值通常不像计算余弦值那么方便，余弦值是一个简单的单位向量的点积。利用三角恒等式sin2 0 + cos2 0 = 1，我们可以得到余弦的折射关系:
$$
t = sin\phi b-cons\phi n
$$
&nbsp;&nbsp;&nbsp;&nbsp;注意，如果n和ne颠倒了，那么9和o也颠倒了，如图14.1右侧所示。
&nbsp;&nbsp;&nbsp;&nbsp;为了将sin o和cos φ转换为3D向量，我们可以在平面法线n和射线方向d的平面上建立一个2D标准正交基。
&nbsp;&nbsp;&nbsp;&nbsp;从图14.2中，我们可以看到n和b形成折射平面的标准正交基。根据定义，我们可以用这个基来描述变换后的射线t的方向:
克斯莫t = sinφb - n。
&nbsp;&nbsp;&nbsp;&nbsp;由于我们可以用相同的基底来描述d，并且d已知，我们可以解出b:
$$
\begin{aligned}
d &= sin\theta\:b -cos\theta\:n,\\
b & =\frac{d+n\:cos\theta}{sin\theta}
\end{aligned}
$$
&nbsp;&nbsp;&nbsp;&nbsp;这意味着我们可以用已知的变量解出t:
$$
\begin{aligned}
t&=\frac{n(d+n~cos\theta)}{n_t}-n~cos\phi \\
& =\frac{n(d-n(d\cdot n))}{n_t}-n\sqrt{1-\frac{n^2(1-(d\cdot n))^2}{n_t^2}}
\end{aligned}
$$
&nbsp;&nbsp;&nbsp;&nbsp;注意，无论n和ne中哪一个更大，这个方程都成立。一个直接的问题是，“如果平方根下的数是负数该怎么办?”在这种情况下，没有折射光线，所有的能量都被反射了。这就是所谓的全内反射，玻璃物体的许多丰富外观都是由它造成的。
&nbsp;&nbsp;&nbsp;&nbsp;对于均匀的杂质，就像在典型的有色玻璃中发现的那样，根据比尔定律，光线的强度会减弱。当射线穿过介质时，它的强度根据dI = -CI dz而衰减，其中dr为距离。因此dI/dz = -CI。我们可以解这个方程得到指数I = kexp(-Cr)衰减程度用RGB衰减常数a来描述，它是经过一个单位距离后的衰减量。引入边界条件，我们知道I(0) = Io, I(1) aI(0)前者意味着I(x) = Io exp(-Cz)。后者意味着Ioa Io exp(-C)，所以-C = In(a)。因此，最后的公式为
$$
I(s) = I(0)e^{ln(a)s}
$$
&nbsp;&nbsp;&nbsp;&nbsp;其中I(s)是距离界面s处的光束强度。因为log的指数在这里，我们也可以把它写成
$$
I(s) = I(0)a^s.
$$
&nbsp;&nbsp;&nbsp;&nbsp;在实践中，我们用肉眼对数据进行逆向工程，因为这样的数据很少容易找到。比尔定律的影响可以在图14.3中看到，玻璃呈现出绿色色调。
这种效果也适用于透射光。这些想法如图14.4所示。注意，如图14.5所示，光线被反复反射和折射。通常，只有一两个反射的图像是容易看到的。
#### 14.4 具有次表面散射的介质
&nbsp;&nbsp;&nbsp;&nbsp;只用光滑的介质，我们就可以渲染出一系列令人惊讶的材料。许多看起来“哑光”和不透明的表面可以模拟成多重介质。
&nbsp;&nbsp;&nbsp;&nbsp;考虑一个完美的冰块。它看起来像一块玻璃，只是它的折射弯曲度更小(冰的折射率比玻璃低)。现在在冰块中放入许多小的球形气囊，随着气泡的加入，它将变得越来越不透明。
&nbsp;&nbsp;&nbsp;&nbsp;散射元素的基本思想可能是空气或其他物质，这在很大程度上造成了我们看到的不透明度。另一种使冰块看起来不透明的方法是使其表面粗糙。这可以在计算机图形模型上完成，通过对曲面进行精细镶嵌，然后对每个三角形顶点的位置进行小的随机扰动。这将产生类似于磨砂玻璃(本质上是那种表面)的效果，扰动越粗糙，不透明度就越高。
&nbsp;&nbsp;&nbsp;&nbsp;通过插入有颜色的粒子，从而激活比尔定律，可以达到进一步的复杂性。这是一种相当简单且惊人准确的模拟油漆的方法。
&nbsp;&nbsp;&nbsp;&nbsp;有许多材料的复杂性可以通过显式的微观结构建模来模拟。例如，人类的皮肤可以被建模为一个粗糙的表面和几层略有不同的折射率、色素颗粒(遵循比尔定律)和血液(遵循比尔定律)。
#### 14.5强力光子追踪器
&nbsp;&nbsp;&nbsp;&nbsp;假设我们将场景建模为带有微结构和一个发光物体的介质?我们如何才能最简单地渲染它并生成图像?在本节中，我们将讨论如何仅仅模拟光子，然后如何从传感器反向发送伴随(反向)光子。这实际上可以用非常少的代码生成一些最好的图形，但速度会非常慢。
##### 14.5.1传感器
&nbsp;&nbsp;&nbsp;&nbsp;为了产生图像，我们必须对图像捕获装置有一定的概念。一个简单的就是一个简单的传感器阵列(比如CCD)和一个盒子，盒子上有一个小孔，这样它就像针孔相机一样。阵列中的每个传感器本质上充当光子计数器(某些波长的响应比其他波长的响应大)。在用光子轰击它之后，传感器阵列的值就可以以图像的形式显示出来。接收到少量光子的传感器将被写入黑色，接收到大量光子的传感器将被写入白色，中间有各种灰度。
&nbsp;&nbsp;&nbsp;&nbsp;为了产生彩色图像，我们可以在传感器前面以某种模式放置红、绿、蓝滤镜。最简单的滤波器是带通滤波器:
1. 除A E [400, 500 nm]外，蓝色无响应。
2. 绿色无响应，只有A E [500, 600 nm]有完全响应。
3. 除了A E [600, 700 nm]有完全响应外，红色无响应。
   
&nbsp;&nbsp;&nbsp;&nbsp;如果你初始化所有传感器为零，那么全响应只是意味着增加存储在传感器的数字，当光子击中它。
#### 14.5.2光子示踪剂
&nbsp;&nbsp;&nbsp;&nbsp;为了跟踪光子，在光源上选择一个随机点，并选择一个随机方向和400到700 nm之间的随机波长(其他波长不会影响传感器阵列，因此不需要计算)。现在按照第4章中描述的方法跟踪这条射线。当它击中一个表面时，计算它的反射率并决定是反射还是折射。这个决定是通过对波长和入射角的Schlick近似进行计算得出的，我们称之为r。现在生成一个均匀随机数ξ E[0,1)。
~~~
如果(६< R)
    生成一个反射光子(射线)并跟踪它
否则
    生成一个折射光子(射线)并跟踪它
~~~
&nbsp;&nbsp;&nbsp;&nbsp;如果表面是金属的，那么这只会改变光子在折射情况下被吸收然后我们在光处开始一个新的光子。
&nbsp;&nbsp;&nbsp;&nbsp;如果光子进入电介质，而比尔定律系数不是1(意味着它像绿色玻璃一样吸收光)，那么光子可能会被吸收(从而死亡)。我们使用与决定反射和折射相同的基本技术来决定:
~~~
如果(६<吸收概率)
    吸收，发射一个新的光子
否则
    光子消失，不参与下一次碰撞
~~~
&nbsp;&nbsp;&nbsp;&nbsp;上面的程序是创建伟大的图像所需要的!只是过程会很慢。
#### 14.5.3运动和离焦模糊
&nbsp;&nbsp;&nbsp;&nbsp;上面的针孔相机将产生非常清晰的图像就像一个真正的针孔相机将。但它需要长时间曝光，因为只有极少数光子幸运地在被吸收前穿过针孔。
&nbsp;&nbsp;&nbsp;&nbsp;我们可以通过在相机上增加一个镜头来解决这个问题，把针孔做大，然后把镜头放在那个孔里。我们可以模拟一组真实的复合玻璃透镜，也可以插入一个理想的薄透镜。
&nbsp;&nbsp;&nbsp;&nbsp;最简单的玻璃透镜，我们可以把它做成两个球体的交点(“双凸球面透镜”)。这具有不错的成像性能(尽管不如大多数真实相机中的复合镜头)，而且很容易为其编写光线交叉代码。
&nbsp;&nbsp;&nbsp;&nbsp;薄透镜是一种理想的无限薄的透镜(在射线追踪程序中会是一个圆盘)，只指定半径(透镜的物理尺寸)和焦距f。薄透镜可以通过强制执行以下三个属性来实现:
1. 从3D点p出发到达透镜中心的光线不会弯曲(我们称这条线从该点经过p的中心线)。
2. 所有离开p点的直线经过镜头后都会在中心线上的点q处汇合。
3. 点p沿透镜光轴的距离a和点q沿透镜光轴的距离b服从薄透镜法则:1/a + 1/b = 1/f
   
&nbsp;&nbsp;&nbsp;&nbsp;通过“沿光轴”，我们将距离从垂直于镜头的轴上移开(因此“瞄准”沿光线)。
&nbsp;&nbsp;&nbsp;&nbsp;注意，有一个区域或理想的镜头会自动给你在真实照片中得到的那种模糊，这通常被称为离焦模糊或景深。
&nbsp;&nbsp;&nbsp;&nbsp;为了解释运动模糊，移动的物体在照片中被模糊了，或者移动的相机模糊了没有以与相机相同的速度移动的物体(例如，想象一张从火车上拍摄的照片，火车内部是清晰的，而风景是模糊的)。如果我们支持两个特性，这种效果就会自动出现:
+ 在相机记录的时间间隔内(或相机快门打开时)，光子以随机的时间从光中发射出来。
+ 射线跟踪器具有将物体移动到射线相交代码的概念，该代码以时间为参数。
  
&nbsp;&nbsp;&nbsp;移动物体的一个简单例子是一个球体，它的中心沿着基于时间的直线:
$$
c(time) = g+time*(h-g).
$$
#### 14.5.4换向时间
&nbsp;&nbsp;&nbsp;&nbsp;上面的光子示踪器可以很好地工作，但是会非常慢，因为即使在你插入透镜之后，大多数光子都不会击中透镜(如果你模拟太阳作为光源)。你将会很幸运有任何一个光子使它到达相机)。
&nbsp;&nbsp;&nbsp;&nbsp;在图形中通常做的事情是把时间倒转，从相机发送光线，当它们击中光线时记录下来。这在我们制作的光子示踪剂中非常容易。相反，我们从每个像素发送光子(技术上是伴随光子)，并观察它们在哪里击中光源。这些光子的波长是通过将彩色滤光片处理为光发射曲线来确定的，当我们击中一个光时，我们用发射光的权重记录光子(在像素传感器阵列上)。
### 14.6辐射线测定
&nbsp;&nbsp;&nbsp;&nbsp;实际上，最后一部分的强力渲染器对于应用程序来说是不可行的。所以我们不是模拟微观几何，而是模拟整体行为。这是使用测量光的实际问题的工具来完成的，通常称为辐射测量。放射学中出现的术语乍一看可能很奇怪，术语和符号可能很难理解。这部分最重要的量是亮度，但大多数图形制作人员如果他们知道什么是亮度，就会把它映射到亮度/颜色/强度的直观概念，在实践中，这在99%的情况下都是有效的。但有时，实际的定义是需要的我们在这里提供它们。
&nbsp;&nbsp;&nbsp;&nbsp;虽然我们可以在许多系统中定义辐射计量单位，但我们使用国际单位制单位。熟悉的国际单位制单位包括米(m)和克(g)。光基本上是能量的一种传播形式，因此定义国际单位制能量单位是很有用的，即焦耳(J)。
#### 14.6.1光谱能量
&nbsp;&nbsp;&nbsp;&nbsp;如果我们有大量的光子，它们的总能量Q可以通过每个光子的能量Q的总和来计算。一个合理的问题是“能量是如何在波长间分布的?”要回答这个问题，一个简单的方法是将光子划分到箱中，本质上是将它们直方图化。然后我们有一个与区间相关的能量。例如，我们可以计算A = 500 nm到A = 600 nm之间的所有能量，得出它是10.2 J，这可以表示为q[500, 600] = 10.2。如果我们把波长区间分成两个50微米的区间，我们可能会发现y[500, 550] = 5.2和(550,G00] = 5.0。这告诉我们，在间隔的一半(500,600)的短波长有更多的能量。如果我们分成2.5 nm的hins，我们可能会发现500,525]= 2.5，等等。这个系统的优点是它很简单。不好的是，区间大小的选择决定了数值。
&nbsp;&nbsp;&nbsp;&nbsp;一种更常用的方法是用能量除以间隔的大小。所以不是q[500,600]=10.2，而是:
$$
Q_{\lambda}[500,600]=\frac{10.2}[100]=0.12J(nm)^{-1}
$$
&nbsp;&nbsp;&nbsp;&nbsp;这种方法很好，因为间隔的大小对数字的总体大小的影响很小。一个直接的想法是驱动区间大小Aλ为零。这可能会很尴尬，因为对于一个足够小的AA, Qx要么是零，要么是巨大的，这取决于是否有一个光子光子在区间内。有两种观点可以解决这一困境。第一种是假设AA很小，但又不至于小到光的量子性质起作用。第二种是假设光是连续的，而不是单个的光子，因此一个真正的导数dQ/dl是合适的。这两种思考方式都是合适的，并导致相同的计算机制。在实践中，大多数测量光的人似乎更喜欢小而有限的间隔，因为这是他们在实验室中可以测量的。大多数从事理论或计算的人喜欢无穷小的间隔，因为这使微积分的机制可用。
&nbsp;&nbsp;&nbsp;&nbsp;Qx被称为光谱能量，它是一个密集的量，而不是粗放的量，如能量、长度或质量。密集量可以被认为是密度函数，它告诉一个广泛量在无穷小点上的密度。例如，在特定波长的能量Q可能是零，但光谱能量(能量密度)Qx是一个有意义的量。一个可能更熟悉的例子是，一个国家的人口可能是2500万，但在这个国家的某一点的人口是没有意义的。然而，以每平方米人口为单位的人口密度是有意义的，只要它是在足够大的区域内测量的。就像光子一样，如果我们假设我们可以把人口看作一个连续体，即人口密度即使在面积很小的情况下也不会变得颗粒状，那么人口密度就能达到最好的效果。
&nbsp;&nbsp;&nbsp;&nbsp;我们将遵循图形的惯例，其中几乎总是使用光谱能量，而很少使用能量。如果使用了“适当的”表示法，这将导致a下标的泛滥。相反，我们将去掉下标并使用Q表示光谱能量。当图形以外的人阅读图形论文时，这可能会导致一些混淆，所以要注意这个标准问题。你对光谱能量的直觉可以通过想象一个带有测量光能Aq的传感器的测量装置来帮助。如果你在传感器前面放置一个彩色滤光片，它只允许在区间[λ - Δλ/2， λ + Δλ/2)内的光，那么在a处的光谱能量是Q = Δq/Δλ。
#### 14.6.2 功率
&nbsp;&nbsp;&nbsp;&nbsp;估计光源的能量产生率是有用的。这个速率叫做功率，它的单位是瓦W，这是焦耳/秒的另一个名字。这在稳定状态下是最容易理解的，但因为功率是一个密集的量(随时间变化的密度)，所以即使能源生产随时间变化，它也可以很好地定义。功率单位可能比较熟悉，例如，100瓦的灯泡。这种灯泡每秒钟消耗大约100j的能量。
&nbsp;&nbsp;&nbsp;光产生的功率实际上会小于100瓦，因为热损失等等，但我们仍然可以用这个例子来帮助理解更多关于光子的知识。例如，我们可以知道100 W的光在一秒钟内产生了多少光子。假设产生的平均光子的能量为al= 500 nm光子。这样一个光子的频率是
$$
f = \frac{c}{\lambda}=\frac{3\times10^8ms^{-1}}{500\times10^{-9}}=6\times10^14s^{-1}.
$$
&nbsp;&nbsp;&nbsp;&nbsp;光子的能量是hf = 4 × 10-19 . j。这意味着即使灯泡效率不高，每秒也能产生惊人的1020个光子。这就解释了为什么用快速快门速度模拟相机和直接模拟光子是产生图像的低效选择。
&nbsp;&nbsp;&nbsp;&nbsp;与能量一样，我们真正感兴趣的是用W(nm)-测量的光谱功率。同样，尽管谱功率的正式标准符号是Φx，但为了方便和与大多数图形文献一致，我们将不带下标使用。需要注意的一点是，光源的光谱功率通常比功率小。例如，如果一束光发出100 W的功率均匀分布在400-800 nm的波长上，那么其光谱功率将为100 W/400 nm = 0.25 W(nm)。如果您为了调试目的手动设置光源的光谱功率，则需要记住这一点。
&nbsp;&nbsp;&nbsp;&nbsp;最后一节中的光谱能量测量装置可以通过在时间t处居中的一段时间间隔内打开的快门进行读取来进行修改。然后光谱功率将为Φ = Δq/(ΔtΔA)。
#### 14.6.3辐照度
&nbsp;&nbsp;&nbsp;&nbsp;如果你问这个问题“有多少光到达这个点?”当然，答案是“没有”，同样，我们必须使用密度函数。如果点在一个表面上，很自然地用面积来定义密度函数。我们修改了上一节的设备，使其具有一个有限的AA面积传感器，小于被测光场。光谱辐照度H是单位面积的功率ΔΦ/ΔA。完全展开
$$
H = \frac{\Delta q}{\Delta A \Delta t \Delta \lambda} \tag{14.3}
$$
&nbsp;&nbsp;&nbsp;&nbsp;因此，辐照度的完整单位为Jm-2s-1(nm)-。注意，SI单位的辐射度包括反平方米的面积和反纳米的波长。这种表面上的不一致(使用纳米和米)是因为面积和可见光波长的自然单位。
&nbsp;&nbsp;&nbsp;&nbsp;当光离开一个表面时，例如当它被反射时，与辐照度相同的量称为辐射出度e。用不同的词来表示入射光和出射光是有用的，因为同一点的辐照度和辐射出度可能不同。
#### 14.6.4光辉
&nbsp;&nbsp;&nbsp;&nbsp;虽然辐照度告诉我们有多少光到达一个点，但它告诉我们的光从哪个方向来。为了测量类似于我们用眼睛看到的东西，我们需要能够将“多少光”与特定的方向联系起来。我们可以想象一个简单的设备来测量这样的数量(图14.6)。我们使用一个小的辐照度计，并添加一个锥形“挡板”，它限制光击中计数器的角度范围与实心角Ao。探测器的响应如下:
$$
\begin{aligned}
response &= \frac{\Delta H}{\Delta \sigma}\\
& = \frac{\Delta q}{\Delta A \Delta\sigma \Delta t \Delta \lambda} 
\end{aligned}
$$
&nbsp;&nbsp;&nbsp;&nbsp;这是光在太空中的光谱辐射。同样，我们将在讨论中去掉“光谱”，并假设它是隐含的。
&nbsp;&nbsp;&nbsp;&nbsp;我们通常在图形程序中计算Radiance。光辉的一个奇妙特性是它不会沿着空间的一条直线变化。要了解为什么这是正确的，检查两个亮度探测器都观察一个表面，如图14.7所示。假设探测器探测的线足够近，使得表面在两个被测区域发射/反射的光“相同”。因为被采样表面的面积与距离的平方成正比，而且由于到达探测器的光与距离的平方成反比，两个探测器应该有相同的读数。
&nbsp;&nbsp;&nbsp;&nbsp;测量击中表面的辐射是有用的。我们可以考虑在表面上的一个点上放置来自亮度探测器的锥形挡板，并从锥内的方向测量表面上的辐照度H(图14.8)。注意，表面“探测器”并没有与锥体对齐。因此，我们需要在亮度的定义中添加余弦修正项:
$$
\begin{aligned}
response &= \frac{\Delta H}{\Delta \sigma cos\theta}\\
& = \frac{\Delta q}{\Delta A cos\theta \Delta\sigma \Delta t \Delta \lambda} 
\end{aligned}
$$
&nbsp;&nbsp;&nbsp;&nbsp;与辐照度和辐射出度一样，区分在表面上某一点入射的辐射和从该点发出的辐射是有用的。这些概念有时在图形文献中使用的术语是表面辐亮度L，表示(离开)一个表面的辐亮度，场辐亮度Ly表示入射到一个表面的辐亮度。两者都需要cos项，因为它们都对应于图14.8中的配置:
$$
L_s = \frac{\Delta E}{\Delta \sigma cos\theta}\\
L_f = \frac{\Delta H}{\Delta \sigma cos\theta}
$$
##### 以辐射度表示的其他辐射量
&nbsp;&nbsp;&nbsp;&nbsp;如果我们有一个表面，它的场辐亮度是Ly，那么我们可以从它推导出所有其他的辐射量。这就是为什么辐射被认为是“基本的”辐射量。例如，辐照度可以表示为
$$
H=\int_{all~k}L_f(k)~cos\theta d\sigma
$$
&nbsp;&nbsp;&nbsp;&nbsp;这个公式有一些在图形中常见的符号约定，这使得不熟悉这些公式的读者无法理解这些公式(图14.9)。第一。K是一个入射方向，可以被认为是一个单位向量，一个方向，或相对于表面法线的球坐标中的(9，φ)对。的方向有一个与之相关的微分立体角。场亮度在每个方向上都可能不同，所以我们把它写成函数L(k)。
&nbsp;&nbsp;&nbsp;&nbsp;作为一个例子，我们可以计算一个表面的辐照度H，在所有方向上都有恒定的场辐亮度Ly。为了积分，我们使用一个经典的球坐标系回忆一下，微分立体角是
$$
d\sigma = sin\theta d\theta d\phi
$$
所以辐照度是
$$
\begin{aligned}
H &= \int_{\phi=0}^{2\pi}\int_{\phi=0}^{\frac{\pi}{2}}cos\theta ~ sin\theta ~d\theta ~d\phi \\
&= \pi L_f
\end{aligned}
$$
&nbsp;&nbsp;&nbsp;&nbsp;这个关系向我们展示了一个可能令人惊讶的常数的首次出现。
&nbsp;&nbsp;&nbsp;&nbsp;这些因子n在辐射测量中经常出现，是我们选择测量立体角的人为因素;也就是说，单位球的面积是π的倍数而不是1的倍数。
&nbsp;&nbsp;&nbsp;&nbsp;类似地，我们可以通过对表面辐亮度的积分来计算撞击表面的功率:
$$
\Phi = \int_{all~X}H(x)dA,
$$
&nbsp;&nbsp;&nbsp;&nbsp;其中x是曲面上的一点，dA是与该点相关的微分面积。注意，对于输入电源和输出电源，我们没有特殊的术语或符号。这种区别似乎并没有引起足够的重视。
### 14.7散射辐射测量
&nbsp;&nbsp;&nbsp;&nbsp;第14.5节的光子跟踪假设所有表面在射线相互作用的水平上都是光滑的，我们假设潜在的复杂几何非常精细。几何细节。在实践中，一个区域的大块属性被平均，使一个区域的行为像精细几何，但不存储它。这部分最重要的概念是，对于粗糙的表面(例如，拉丝钢)，我们不是用实际的几何图形来表示所有的微小划痕，而是统计地描述划痕，并使光滑的表面随机地从多个方向反射光线，就好像表面上有看不见的小细节一样。这个函数称为双向反射率分布函数(BRDF)。第二个重要的概念是一个非常类似的想法，低光散射在一个体积(例如，一个冰块中的气泡或云中的水滴)。而而不是代表体积中所有的小颗粒/气泡/液滴，我们只需建立一个统计模型，计算光在任何给定3D位置散射的可能性、被吸收的可能性以及散射光的方向分布。这个方向分布就是PDF，叫做体积的相函数。我们不进一步讨论相函数或体积输运;有关这些主题的更多信息，请参阅章节注释。
#### 14.7.1双向反射
&nbsp;&nbsp;&nbsp;&nbsp;因为我们对表面的外观感兴趣，我们想要描述一个表面是如何反射光的。直观地说，对于任何来自k方向的入射光，都有一部分分散在出射方向ko附近的小立体角中。我们有很多方法可以将这一概念形式化，毫不奇怪，标准的方法是构建一个简单的测量设备。这样的器件如图14.10所示，其中一个小光源位于k方向;从表面上的一个点看，探测器被放置在ko方向上。对于每个方向对(ki, ko)，我们用探测器读取一个读数。
&nbsp;&nbsp;&nbsp;&nbsp;现在我们只需要决定如何测量光源的强度，并使反射函数与这个强度无关。例如，如果我们用一种更亮的光来代替光线，我们就不会认为表面反射的光线是不同的。我们可以在被照亮的点上放置一个亮度计来测量光线。然而，为了得到一个准确的读数,将不依赖于探测器的Ao，我们将需要光面对一个大于Ao的立体角。不幸的是，我们的漫游辐射探测器在ko方向所做的测量也将计算来自新探测器锥外点的光。所以这看起来不像是一个实际的解决方案。
&nbsp;&nbsp;&nbsp;&nbsp;或者，我们可以在被测量的表面上放置一个辐照度计。这将需要一个不强烈依赖于光源几何的细微差别的读数。这就建议用一个比率来描述反射率:
$$
\rho = \frac{L_s}{H},
$$
&nbsp;&nbsp;&nbsp;&nbsp;其中，这个分数p将随着入射和出射方向k和ko的变化而变化，H是光位置k的辐照度，L是在ko方向测量的表面亮度。如果我们对所有方向对进行这样的测量，我们最终得到一个4D函数p(k;， ko)。这个函数称为双向反射率分布函数(BRDF)。BRDF是我们所需要知道的，以表征一个表面如何反射光的方向特性。
#### 定向半球形反射
&nbsp;&nbsp;&nbsp;&nbsp;双向反射。问起来很直接。“入射光的反射率是多少?”然而，答案并不那么容易;反射的比例取决于入射光的方向分布。因此，我们通常只设置一个固定入射方向k的反射分数，。这个分数叫做定向半球反射率。这个分数R(ki)的定义是
$$
R(k_i) = \frac{来自所有方向K_0的出射光功率}{从指定k_i方向入射的到一个柱状范围的功率}
$$
&nbsp;&nbsp;&nbsp;&nbsp;注意，由于能量守恒的原因，这个量在0到1之间。
&nbsp;&nbsp;&nbsp;&nbsp;如果我们允许入射功率;打在小面积AA上，则辐照度为Φi/ΔA。此外，入射功率之比就是辐射出度与辐照度之比:
$$
R(k_i)= \frac{E}{H}
$$
根据BRDF的定义，这种功率在特定方向上产生的辐射:
$$
L(k_0)=H\rho(k_i,k_0) = \frac{\Phi_i}{\Delta A}
$$
从光辉的定义来看，我们还有ΔΕ
$$
L(k_0) = \frac{\Delta E}{\Delta \sigma_0 cos\phi_0},
$$
&nbsp;&nbsp;&nbsp;&nbsp;其中E为小斑块向ko方向的辐射出度。利用亮度的这两个定义，我们得到
$$
H\rho(k_i,k_0) = \frac{\Delta E}{\Delta \sigma_0 cos\phi_0}
$$
重新排列术语，我们得到Ε
$$
\frac{\Delta A}{H}= \rho(k_i,k_0) \Delta \sigma_0 cos\phi_0
$$
&nbsp;&nbsp;&nbsp;&nbsp;这只是反映在特定k附近的对E/H的微小贡献。
&nbsp;&nbsp;&nbsp;&nbsp;为了找到总R(ki)，我们把所有输出的ko加起来。积分形式是
$$
R(k_i) = \int_all k_0 \rho(k_i,k_0)cos\theta_0d\theta_0
$$
##### 理想的双向扩散
&nbsp;&nbsp;&nbsp;&nbsp;一个理想化的扩散面被称为兰伯面。由于热力学的原因，这样的表面在自然界中是不可能存在的，但在数学上，它们确实能保存能量。
朗伯氏BRDF对所有角p都等于常数。这意味着表面在所有观看角度都有相同的亮度，而这个亮度将与辐照度成正比。
&nbsp;&nbsp;&nbsp;&nbsp;如果我们计算p = C的朗伯曲面的R(ki)，我们得到
$$
\begin{aligned} 
R(K_i) &= \int_{allk_0}C\cos\theta_0d\sigma \\
 &= \int_{\phi_0=0}^{2\pi}\int_{\phi_0=0}{2\pi}C\cos\theta_0\sin\theta_d\phi_0\\
 &=\pi C
\end{aligned}
$$
&nbsp;&nbsp;&nbsp;&nbsp;因此，对于一个完全反射的兰伯曲面(R=1)，我们有$\rho=1/\pi$，而对于一个R(k_i)=r的兰伯曲面，我们有
$$
\rho(k_i,k_0)=\frac{r}{\pi}
$$
&nbsp;&nbsp;&nbsp;&nbsp;这是另一个例子，使用立体角的立体量决定了lie的归一化速变量，从而引入了a的因子。
***
### 14.8传输方程
&nbsp;&nbsp;&nbsp;&nbsp;根据BRDF的定义，我们可以用来自不同方向的入射辐射来描述一个表面的辐亮度。因为在计算机图形学中，我们可以使用理想化的数学来实例化在实验室里，我们也可以只用亮度来表示BRDF。如果我们取一小部分光与实角Ao;光辉L;并“测量”由于这一小片光在ko方向的反射亮度，我们可以计算BRDF(图14.11)。小片光的辐照度为H= L;cosθ,Δσ;。因此，BRDF为
$$
\rho = \frac{L_0}{L_i\cos\theta_i\Delta\sigma_i}
$$
&nbsp;&nbsp;&nbsp;&nbsp;这种形式在某些情况下是有用的。重新排列术语，我们可以写下来自k方向的光的亮度部分:
$$
\Delta L_0=\rho(k_i,k_0)L_i\cos\phi_i\Delta\sigma_i
$$
&nbsp;&nbsp;&nbsp;&nbsp;如果光从多个方向Li(ki)来，我们可以把它们都加起来。在积分形式中，加上表面和场亮度的符号，这是
$$
L_s(K_0)=\int_{all~k_i}\rho(k_i,k_0)L_i\cos\phi_id\sigma_i \tag{14.4}
$$
&nbsp;&nbsp;&nbsp;&nbsp;在计算机图形学中，这通常被称为渲染方程(Kajiya, 1986)，最初是由(Immel, Cohen， & Greenberg, 1986)以这种形式编写的。
&nbsp;&nbsp;&nbsp;&nbsp;有时，只将输运方程写成表面辐射的形式是有用的。注意，在封闭环境中，场辐亮度Ly(k;)来自某些表面，其表面辐亮度La(-k;) = Ly(k;)(图14.12)。图中点x'所对应的立体角由
$$
\Delta\sigma_i=\frac{\Delta A'\cos\phi'}{||x-x'||^2}
$$
&nbsp;&nbsp;&nbsp;&nbsp;其中AA'是与x'相关的区域。代替Δo;的表达式ΔA'表示以下传输方程:
$$
L_s(x,k_0)=\int_{all~x'~visable~to~x}\frac{\rho(k_i,k_0)L_s(x',x-x')\cos\phi_i\cos\phi'}{||x-x'||^2}dA'.
$$
&nbsp;&nbsp;&nbsp;&nbsp;注意，我们使用了一个非归一化向量x - x'来表示从x'到x的方向。还要注意，我们把Ls写成了位置和方向的函数。
&nbsp;&nbsp;&nbsp;&nbsp;这个新的输运方程的唯一问题是积分域很棘手。如果我们引入一个可见性函数，我们可以用被积函数的复杂度来权衡定义域的复杂度:
$$
L_s(x,k_0)=\int_{all~x'}\frac{\rho(k_i,k_0)L_s(x',x-x')\cos\phi_i\cos\phi'}{||x-x'||^2}dA'.
$$
当
$$
v(x,x')=
\begin{cases} &1 &if~x~and~x'are~mutually~visable, \\ 
&0 &otherwise
\end{cases}
$$

***
### 14.9 实践材料
&nbsp;&nbsp;&nbsp;&nbsp;在正常的观看距离下，许多真实的材料都有可见的结构。例如，大多数地毯都有很容易看到的绒毛，有助于外观。就我们的目的而言，这样的结构不是材料属性的一部分，而是几何模型的一部分。结构的细节在正常的观察距离是看不见的，但它决定了宏观材料的外观，是材料属性的一部分。例如，纸上的纤维在放大下有一个复杂的外观，但当在一臂距离观察时，它们在一起被模糊成均匀的外观。折叠成BRDF的微结构之间的这种区分有些武断，取决于人们定义的“正常”观看距离和视力，但这种区分在实践中已被证明相当有用。
&nbsp;&nbsp;&nbsp;&nbsp;文献中有许多BRDF模型，并在行业中使用。许多领域都使用BRDF模型，包括遥感、热传导、材料科学，当然还有计算机图形学。不幸的是，这些领域并没有一个标准的术语集，甚至在图形领域也没有。然而，这些是大多数人都同意的术语，如图14.13所示。
该行业的实践是将材料分为这些类别，并对每个术语有不同的BRDF模型。然后将这些模型项与常数或由菲涅耳(Schlick)变化确定的简单权值相结合。关键问题是使用什么术语。越来越多的实践确定了为计算机生成动画开发的Burley/Disney模型的变体(Burley. 2012)。但现在它也被广泛应用于游戏和产品设计中。它包含了图14.13中每个主要类别的术语，
&nbsp;&nbsp;&nbsp;&nbsp;还有一个额外的叶:光泽。它没有被包含在图14.13的分类中，因为它不是一个在图形内部广泛使用的术语，也不是图形外部的技术术语。光泽术语被用来解释放牧角度的影响，如边缘照明，可以看到，特别是在皮肤和织物上，更多的信息可以在Estevez, Imageworks和Kulla (n.d.)中找到。在某些情况下，反向反射术语非常重要，但在图形中不常用。
&nbsp;&nbsp;&nbsp;&nbsp;在实际应用中，BRDF模型中最普遍使用的两个术语是弥散叶瓣和光滑叶瓣。一个常数通常用于漫射，但也有其他的变化，在掠射角度变得更暗，在光滑的lohe接管。目前最主要的光滑瓣是GGX微面瓣(Walter, Marschner, Li， & Torrance, 2007)。微facet的叶瓣与我们用蛮力表示粗糙表面的方法密切相关，但只是找到微facet的表面法线的统计分布。请注意，这些microfacet方法是对具有microfacet的实际表面的近似。Heitz(2014)深入讨论了这个主题，并着眼于实现。

***
### 14.10蒙特卡罗射线追踪
&nbsp;&nbsp;&nbsp;&nbsp;一旦我们将照明表示为一个积分，我们就可以使用蒙特卡洛积分(参见2.12节)来求解它。回想一下对于f(r)的积分，蒙特卡洛积分就是许多随机样本的平均值：
$$
\int_sf(x)du(x)\approx average(\frac{f(x_{random})}{p(x_{random})},)
$$
&nbsp;&nbsp;&nbsp;&nbsp;p是s域上的概率密度函数如果我们把它应用到公式14.4，那么对于一个随机样本方向q，我们得到
$$
L_s(k_0)\approx \frac{\rho(q,k_0)L_f(q)\cos\theta_i}{p(q)}
$$
&nbsp;&nbsp;&nbsp;&nbsp;注意，对于噪声较小的图像，我们将对许多噪声样本进行平均。我们怎么做呢?首先，我们需要一种为某个PDF p生成随机方向的方法。记住，p可以是任何有效的PDF，所以我们用统一的方法:p = 1/(2π/)。这个值是因为积分除以“表面以上所有入射方向的立体角”，而立体角是投影到单位球上的面积，而“表面以上”的方向是半个球，面积为2π。
&nbsp;&nbsp;&nbsp;&nbsp;在代码中，对于入射射线方向a，它看起来是这样的:
```
pick random direction q
color = ρ(q, a)Lf (q) cos θi/p(q
```
&nbsp;&nbsp;&nbsp;&nbsp;那么从q方向来的颜色f是什么呢?实际上我们可以应用蒙特递归的卡罗积分(这并不明显，但可以使用随机变量的属性来表示，即使在和的项不是独立的情况下，期望值和)。如果我们写一个函数L(o, d)它返回来自d方向的p点的颜色，加上发射的光，这样就可以看到一些东西，然后我们可以写一个递归函数
```
unction rgb radiance(o, d)
    if ray o + td hits something then
        p = hit point
        q = random direction
        return emitted(p)+(ρ(q, –d) cos θi/p(q))* radiance(p, q)
    else
        return background(o, d)
```
&nbsp;&nbsp;&nbsp;&nbsp;注意，如果环境是关闭的，该函数永远不会终止，因此应该为关闭的环境添加一些终止救助。后台函数可以返回一个常量，也可以查找环境映射或其他随方向变化的函数。最后，除了背景外，不需要灯光来获得好的照片。
&nbsp;&nbsp;&nbsp;&nbsp;你可能会注意到这与本章前面开发的伴随光子示踪剂非常相似。推导的方法是不同的，采用显式的辐射积分方法，但它确实得到了相似的结论。
&nbsp;&nbsp;&nbsp;&nbsp;在实践中，当灯光很小时，该算法将非常嘈杂，因为emit()的值可能很大，对于小的灯光很少。相反，人们经常通过分别计算发光物体的贡献来打破直接照明。例如,
```
unction rgb radiance(o, d)
    if ray o + td hits something then
        p = hit point
        q = random direction
        return directLightAt(p)+(ρ(q, –d) cos θi/p(q))* radiance(p, q)
    else
        return background(o, d)
```
&nbsp;&nbsp;&nbsp;&nbsp;在这里，directLightAt(p)计算直接照明，即，由于光子离开灯光到达p而没有任何干涉表面而产生的颜色。这段代码的特点是，直接看到的灯看起来是黑色的(在代码中没有显式的发射术语)，所以实际上真正的代码需要以某种方式处理这个问题。
&nbsp;&nbsp;&nbsp;&nbsp;直接照明也经常使用蒙特卡洛计算，但通常使用面积测量只在光源上选取样本，从而计算公式14.5。
&nbsp;&nbsp;&nbsp;&nbsp;请注意，只要材料不是完全光滑的，即图14.13中的脉冲，上述方法就可以正常工作。从技术上讲，对于这些材料，BRDF是一个在一个方向上具有无穷大值的增量函数，因此它在形式上是可行的，但与计算机浮点算术不同。在这里，我们需要一个“if”来处理这些材料，就像在第四章中处理射线一样。

***
### 常见问题
•什么是“强度”?
&nbsp;&nbsp;&nbsp;&nbsp;“强度”一词在不同的语境中使用，其用法随时代和学科的不同而不同。在实践中，它不再是一个特定的辐射量的意义，但它是有用的直观讨论。大多数的论文都用它来代替亮度。
•什么是“radiosity”?
&nbsp;&nbsp;&nbsp;&nbsp;在某些领域，用辐射度这个术语来代替辐射度。它有时也被用来描述世界空间光传输算法。
•即使使用复杂的BRDF，我的图像看起来也太平滑了。我哪里做错了?
&nbsp;&nbsp;&nbsp;&nbsp;BRDFs只捕捉到肉眼无法分辨的亚像素细节。大多数真实的表面也有一些小的变化，比如皮肤上可以看到的皱纹。如果你想要真正的现实主义，就需要一些纹理或位移贴图。
•如何将BRDF与纹理映射集成?
&nbsp;&nbsp;&nbsp;&nbsp;纹理映射可以用来控制表面上的任何参数。因此BRDF使用的任何颜色或控制参数都应该是可编程的。
•我有非常漂亮的代码，除了我的材料类。我哪里做错了?
&nbsp;&nbsp;&nbsp;&nbsp;你可能并没有做错什么。在每个人的程序中，物质类往往是丑陋的东西。如果你找到一个很好的方法来处理它，请告诉我们!我们自己的代码使用了一个着色器架构(Hanrahan & Lawson, 1990)，这使得材料包含了很多渲染算法。
•人们用什么模型来计算相函数?
&nbsp;&nbsp;&nbsp;&nbsp;几乎唯一使用的模型是henye - greenstein函数，它只有一个参数来控制它的“拉伸”程度。
•BRDF和相位函数看起来很相似，为什么它们被区别对待呢?
&nbsp;&nbsp;&nbsp;&nbsp;BRDF实际上可以作为相位函数和散射反照率来处理，但由于历史和实际测量的原因，它们通常被区别对待。在代码中给它们一个统一的表示是可以的，但是需要一些解释给习惯于BRDFs的人。

***
### 笔记
&nbsp;&nbsp;&nbsp;&nbsp;在光线追踪框架中还有许多其他的高级方法可以实现。一些进一步信息的资源是Glassner’s An射线追踪和数字图像合成原理介绍，Shirley的《一个周末中的射线追踪》系列，Pharr等人的《基于物理的渲染:从理论到实现》，Akenine-Möller等人的《实时渲染》，两个射线追踪宝石集，以及McGuire的《图形编码器》。
&nbsp;&nbsp;&nbsp;&nbsp;在本章中没有描述的一个常见的辐射量是辐射强度(I)，它是一个无穷小点源发出的每立体面的光谱功率。在图形程序中通常应该避免它，因为点源会导致实现问题。在模拟光传输的解析方法(Arvo, 1995a)中可以找到对辐射测量的更严格的处理。本章中的辐射和光度术语来自照明工程协会的标准，该标准被科学和工程的所有领域越来越多地使用(美国国家标准协会，1986)。关于辐射和外观标准的更广泛的讨论可以在《数字图像合成原理》(Glassner, 1995)中找到。
文献中描述了许多BRDF模型，这里只描述了其中的少数。其他包括(Cook&Torrance,  1982;他等。1992;奥伦和纳亚尔，1994;重,1994;拉福福，托伦斯，格林伯格，1997;斯塔姆,1999;阿希克明，普雷莫兹，和雪莉，2000;Ershov Kolchin,&梅什科夫斯基，2001;Matusik， Pfister， Brand， & McMillan， 2003;劳伦斯 Rusinkiewicz， & Ramamoorthi， 2004;Stark， Arvo， & Smits， 2005）。所需的BRDF模型的特征在使着色器更物理上可信(Lewis, 1994)中进行了讨论。现代电影和游戏工作室的活动非常受关注，因为材料模型仍在发展，Unity、Solid Angle、迪士尼和索尼都是有趣的例子。到目前为止，对于光鲜的术语，占主导地位的模型是GGX模型，它在PRRT的书和弗里克·海茨(Fric Heitz)合著的许多论文中有广泛的介绍。＆德昂，2014 年）。

***
### 练习
1. 假设我们用形式为C cos;的BRDF来代替Lambertian BRDF。为了节约能源，C必须是什么?
2. 练习1中的BRDF不是互惠的。你能把它修改成倒数吗?
3. 类似高速公路标志的东西是反光装置。这意味着当k和ko彼此接近时，BRDF很大。让模特有灵感通过Phong模型，该模型捕获了反反射行为，同时具有互反性和节能。
4. 对于发散辐亮度为L的扩散表面，辐亮度是多少?
5. 一个面积为4m2，辐射为L的漫反射表面的总功率是多少?
6. 如果一个荧光灯和一个白炽灯都消耗20瓦的电力，为什么荧光灯通常是首选?
